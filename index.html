<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messenger PRO</title>

<style>
:root{--accent:#2563eb;--bg:#f3f4f6}
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:var(--bg);height:100vh;display:flex}
.app{display:grid;grid-template-columns:280px 1fr;width:100%;padding:10px;gap:10px}
.panel{background:#fff;border-radius:10px;box-shadow:0 8px 25px rgba(0,0,0,.08);display:flex;flex-direction:column}
.top{padding:12px;border-bottom:1px solid #eee;font-weight:bold;display:flex;flex-wrap:wrap;gap:6px}
.top input{flex:1 1 120px}
.contacts{flex:1;overflow:auto}
.contact{padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.contact .name{display:flex;align-items:center;gap:6px}
.unread{font-weight:bold}
.badge{background:#ef4444;color:white;border-radius:12px;padding:2px 8px;font-size:12px}
.online{color:green;font-size:12px}
.offline{color:red;font-size:12px}
.messages{flex:1;padding:15px;overflow:auto}
.message{margin-bottom:10px;max-width:70%;padding:8px;border-radius:8px}
.me{background:#dbeafe;margin-left:auto}
.them{background:#f1f5f9}
.composer{display:flex;padding:10px;border-top:1px solid #eee;gap:6px}
input{padding:8px;border-radius:6px;border:1px solid #ddd}
button{padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
button:disabled{opacity:0.5;cursor:not-allowed}
.primary{background:var(--accent);color:#fff}
.callBox{position:fixed;bottom:20px;right:20px;background:#fff;padding:15px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none}
.context-menu{position:absolute;background:white;border:1px solid #ccc;border-radius:4px;padding:4px 0;box-shadow:2px 2px 5px rgba(0,0,0,0.2);z-index:1000;display:none}
.context-menu div{padding:8px 16px;cursor:pointer}
.context-menu div:hover{background:#f0f0f0}
</style>
</head>

<body>
<div class="app">

<div class="panel">
<div class="top">
<input id="myName" placeholder="–í–∞—à –Ω–∏–∫" autocomplete="off">
<input id="myPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button id="connectBtn">–í–æ–π—Ç–∏</button>
<button id="logoutBtn" style="display:none">–í—ã–π—Ç–∏</button>
</div>

<div style="padding:10px;border-bottom:1px solid #eee;display:flex;gap:5px">
<input id="friendName" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞" style="flex:1" disabled>
<button id="addFriend" disabled>+</button>
</div>

<div class="contacts" id="contacts"></div>
</div>

<div class="panel">
<div class="top" id="chatHeader">–ß–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
<div class="messages" id="messages"></div>

<div class="composer">
<input id="messageInput" style="flex:1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" disabled>
<button class="primary" id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
<button id="callBtn" disabled>üìû</button>
</div>
</div>

</div>

<div class="callBox" id="callBox">
<div id="callStatus">–ó–≤–æ–Ω–æ–∫...</div>
<button id="endCall">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
</div>

<audio id="msgSound" src="message.mp3" preload="auto"></audio>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
<div id="contextMenu" class="context-menu">
  <div data-action="clear">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</div>
  <div data-action="delete">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç</div>
</div>

<script>
let socket;
let myName = "";
let authenticated = false;

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–ª—é—á —Å –∏–º–µ–Ω–µ–º)
function loadStateForUser(username) {
    if (!username) return { contacts: [], conversations: {}, online: {}, lastActivity: {}, unread: {} };
    const saved = localStorage.getItem(`messenger_state_${username}`);
    return saved ? JSON.parse(saved) : { contacts: [], conversations: {}, online: {}, lastActivity: {}, unread: {} };
}

function saveStateForUser(username, state) {
    if (username) {
        localStorage.setItem(`messenger_state_${username}`, JSON.stringify(state));
    }
}

let state = loadStateForUser(null); // –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—É—Å—Ç–æ–π
let active = null;

let peer;
let localStream;

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
const contactsEl = document.getElementById("contacts");
const messagesEl = document.getElementById("messages");
const chatHeader = document.getElementById("chatHeader");
const msgSound = document.getElementById("msgSound");
const callBox = document.getElementById("callBox");
const contextMenu = document.getElementById("contextMenu");

// –ö–Ω–æ–ø–∫–∏/–∏–Ω–ø—É—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–æ –≤—Ö–æ–¥–∞
const friendNameInput = document.getElementById("friendName");
const addFriendBtn = document.getElementById("addFriend");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const callBtn = document.getElementById("callBtn");
const connectBtn = document.getElementById("connectBtn");
const logoutBtn = document.getElementById("logoutBtn");
const myNameInput = document.getElementById("myName");
const myPasswordInput = document.getElementById("myPassword");

// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
function setInterfaceEnabled(enabled) {
    [friendNameInput, addFriendBtn, messageInput, sendBtn, callBtn].forEach(el => {
        el.disabled = !enabled;
    });
    // –ö–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
}

function renderContacts() {
    if (!authenticated) {
        contactsEl.innerHTML = '<div style="padding:10px;color:#999;">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã</div>';
        return;
    }
    const sorted = [...state.contacts].sort((a, b) => {
        const tA = state.lastActivity[a] || 0;
        const tB = state.lastActivity[b] || 0;
        if (tA !== tB) return tB - tA;
        return a.localeCompare(b);
    });

    contactsEl.innerHTML = "";
    sorted.forEach(name => {
        const unreadCount = state.unread[name] || 0;
        const div = document.createElement("div");
        div.className = "contact";
        div.setAttribute("data-contact", name);
        div.innerHTML = `
            <span class="name ${unreadCount > 0 ? 'unread' : ''}">
                ${name}
                ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : ''}
            </span>
            <span class="${state.online[name] ? 'online' : 'offline'}">
                ${state.online[name] ? '‚óè online' : '‚óè offline'}
            </span>
        `;
        // –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ ‚Äì –≤—ã–±–æ—Ä —á–∞—Ç–∞
        div.addEventListener("click", (e) => {
            if (e.button !== 0) return; // —Ç–æ–ª—å–∫–æ –ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞
            active = name;
            chatHeader.textContent = "–ß–∞—Ç —Å " + name;
            if (state.unread[name]) {
                state.unread[name] = 0;
                saveStateForUser(myName, state);
            }
            renderMessages();
            renderContacts();
        });
        // –ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ ‚Äì –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        div.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            if (!authenticated) return;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç, –Ω–∞–¥ –∫–æ—Ç–æ—Ä—ã–º –≤—ã–∑–≤–∞–Ω–æ –º–µ–Ω—é
            contextMenu.setAttribute("data-contact", name);
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é
            contextMenu.style.left = e.pageX + "px";
            contextMenu.style.top = e.pageY + "px";
            contextMenu.style.display = "block";
        });
        contactsEl.appendChild(div);
    });
}

function renderMessages() {
    if (!authenticated || !active) {
        messagesEl.innerHTML = "";
        return;
    }
    const conv = state.conversations[active] || [];
    messagesEl.innerHTML = "";
    conv.forEach(m => {
        const div = document.createElement("div");
        div.className = "message " + (m.from === myName ? "me" : "them");
        div.textContent = m.text;
        messagesEl.appendChild(div);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

function connect() {
    const name = myNameInput.value.trim();
    const password = myPasswordInput.value.trim();
    if (!name || !password) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å");

    socket = new WebSocket("ws://localhost:3000");

    socket.onopen = () => {
        socket.send(JSON.stringify({ type: "auth", name, password }));
    };

    socket.onmessage = async e => {
        let data = JSON.parse(e.data);

        if (data.type === "error") {
            alert("–û—à–∏–±–∫–∞: " + data.message);
            socket.close();
            return;
        }

        if (data.type === "auth_success") {
            // –£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            authenticated = true;
            myName = name;
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            state = loadStateForUser(myName);
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
            connectBtn.style.display = "none";
            logoutBtn.style.display = "inline-block";
            setInterfaceEnabled(true);
            // –†–µ–Ω–¥–µ—Ä–∏–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è
            renderContacts();
            renderMessages();
            return;
        }

        if (data.type === "onlineList") {
            if (!authenticated) return;
            state.online = data.users;
            saveStateForUser(myName, state);
            renderContacts();
        }

        if (data.type === "message") {
            if (!authenticated) return;
            if (!state.conversations[data.from])
                state.conversations[data.from] = [];
            state.conversations[data.from].push(data);
            if (!state.contacts.includes(data.from))
                state.contacts.push(data.from);

            state.lastActivity[data.from] = Date.now();

            if (active !== data.from) {
                state.unread[data.from] = (state.unread[data.from] || 0) + 1;
            }

            msgSound.play();
            saveStateForUser(myName, state);
            renderContacts();
            renderMessages();
        }

        if (data.type === "signal") {
            if (!authenticated) return;
            await handleSignal(data);
        }
    };

    socket.onclose = () => {
        // –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–ª–æ—Å—å, –Ω–æ –º—ã –µ—â—ë –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã ‚Äì –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ offline?
        if (authenticated) {
            // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        }
    };
}

function logout() {
    if (socket) {
        socket.close();
    }
    authenticated = false;
    myName = "";
    active = null;
    state = { contacts: [], conversations: {}, online: {}, lastActivity: {}, unread: {} };
    setInterfaceEnabled(false);
    connectBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    renderContacts();
    renderMessages();
    chatHeader.textContent = "–ß–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω";
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
    myNameInput.value = "";
    myPasswordInput.value = "";
}

// –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é: –¥–µ–π—Å—Ç–≤–∏—è
document.querySelectorAll("[data-action]").forEach(item => {
    item.addEventListener("click", (e) => {
        const action = e.target.getAttribute("data-action");
        const contact = contextMenu.getAttribute("data-contact");
        if (!contact) return;

        if (action === "clear") {
            // –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
            if (state.conversations[contact]) {
                state.conversations[contact] = [];
            }
            state.unread[contact] = 0;
            // –û—Å—Ç–∞–≤–ª—è–µ–º lastActivity, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –ø–æ–∑–∏—Ü–∏—é
            saveStateForUser(myName, state);
            if (active === contact) renderMessages();
            renderContacts();
        } else if (action === "delete") {
            // –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
            const idx = state.contacts.indexOf(contact);
            if (idx !== -1) state.contacts.splice(idx, 1);
            delete state.conversations[contact];
            delete state.lastActivity[contact];
            delete state.unread[contact];
            saveStateForUser(myName, state);
            if (active === contact) {
                active = null;
                chatHeader.textContent = "–ß–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω";
                renderMessages();
            }
            renderContacts();
        }
        contextMenu.style.display = "none";
    });
});

// –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener("click", () => {
    contextMenu.style.display = "none";
});

// –ó–∞–ø—É—Å–∫ –∑–≤–æ–Ω–∫–∞ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
async function startCall() {
    if (!authenticated || !active) return;
    // ... (–∫–æ–¥ –∑–≤–æ–Ω–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
}

function createPeer() {
    // ... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
}

async function handleSignal(data) {
    // ... (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
}

// –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
connectBtn.onclick = connect;
logoutBtn.onclick = logout;

addFriendBtn.onclick = () => {
    if (!authenticated) return;
    let f = friendNameInput.value.trim();
    if (!f) return;
    if (!state.contacts.includes(f))
        state.contacts.push(f);
    friendNameInput.value = "";
    saveStateForUser(myName, state);
    renderContacts();
};

sendBtn.onclick = () => {
    if (!authenticated || !active) return;
    let text = messageInput.value.trim();
    if (!text) return;
    let msg = { type: "message", from: myName, to: active, text };
    if (!state.conversations[active])
        state.conversations[active] = [];
    state.conversations[active].push(msg);

    state.lastActivity[active] = Date.now();
    if (state.unread[active]) state.unread[active] = 0;

    socket.send(JSON.stringify(msg));
    messageInput.value = "";
    saveStateForUser(myName, state);
    renderMessages();
    renderContacts();
};

callBtn.onclick = startCall;
document.getElementById("endCall").onclick = () => {
    if (peer) peer.close();
    callBox.style.display = "none";
};

// –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äì –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
setInterfaceEnabled(false);
renderContacts();
</script>

</body>
</html>
