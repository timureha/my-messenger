<!doctype html>
<html lang="ru" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Messenger PRO</title>
<style>
/* ‚îÄ‚îÄ –¢–µ–º—ã ‚îÄ‚îÄ */
:root {
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --bg: #f3f4f6;
    --panel: #ffffff;
    --border: #e5e7eb;
    --text: #111827;
    --text2: #6b7280;
    --me-bg: #dbeafe;
    --them-bg: #f1f5f9;
    --input-bg: #ffffff;
    --input-border: #d1d5db;
    --hover: #f9fafb;
    --shadow: rgba(0,0,0,.08);
    --topbar-bg: #ffffff;
}
[data-theme="dark"] {
    --bg: #0f172a;
    --panel: #1e293b;
    --border: #334155;
    --text: #f1f5f9;
    --text2: #94a3b8;
    --me-bg: #1e40af;
    --them-bg: #334155;
    --input-bg: #1e293b;
    --input-border: #475569;
    --hover: #263148;
    --shadow: rgba(0,0,0,.3);
    --topbar-bg: #1e293b;
}

/* ‚îÄ‚îÄ Reset ‚îÄ‚îÄ */
*, *::before, *::after { box-sizing: border-box; }
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
    font-size: 14px;
    background: var(--bg);
    color: var(--text);
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: background .2s, color .2s;
}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.app {
    display: grid;
    grid-template-columns: 300px 1fr;
    flex: 1;
    min-height: 0;
    gap: 10px;
    padding: 10px;
}
.panel {
    background: var(--panel);
    border-radius: 12px;
    box-shadow: 0 4px 20px var(--shadow);
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
    transition: background .2s;
}

/* ‚îÄ‚îÄ Top bars ‚îÄ‚îÄ */
.top {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    background: var(--topbar-bg);
    transition: background .2s, border-color .2s;
}
.top-title { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ‚îÄ‚îÄ Inputs & Buttons ‚îÄ‚îÄ */
input, textarea {
    padding: 9px 12px;
    border-radius: 8px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    outline: none;
    transition: border-color .15s, background .2s;
}
input:focus { border-color: var(--accent); }
button {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-family: inherit;
    transition: background .15s, opacity .15s;
}
button:active { opacity: .8; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-icon {
    font-size: 18px;
    padding: 6px 9px;
    background: transparent;
    color: var(--text2);
    border-radius: 8px;
}
.btn-icon:hover { background: var(--hover); color: var(--text); }
.btn-danger { background: #fee2e2; color: #dc2626; }
.btn-danger:hover { background: #fecaca; }

/* ‚îÄ‚îÄ Add friend row ‚îÄ‚îÄ */
.add-friend-row {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 6px;
    flex-shrink: 0;
}
.add-friend-row input { flex: 1; }

/* ‚îÄ‚îÄ Contacts ‚îÄ‚îÄ */
.contacts { flex: 1; overflow-y: auto; }
.contact {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    transition: background .12s;
}
.contact:hover { background: var(--hover); }
.contact.active-contact { background: var(--me-bg); }
.contact-left { display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 0; }
.contact-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.contact-typing { font-size: 11px; color: var(--accent); font-style: italic; height: 14px; }
.contact-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
.status-online { color: #16a34a; font-size: 11px; }
.status-offline { color: var(--text2); font-size: 11px; }
.unread-badge {
    background: #dc2626; color: #fff; border-radius: 999px;
    font-size: 11px; font-weight: 700;
    min-width: 18px; height: 18px;
    display: flex; align-items: center; justify-content: center;
    padding: 0 5px;
}

/* ‚îÄ‚îÄ Chat panel ‚îÄ‚îÄ */
.messages {
    flex: 1;
    padding: 14px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.message {
    max-width: 72%;
    padding: 8px 11px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 3px;
    word-break: break-word;
}
.me { background: var(--me-bg); margin-left: auto; align-items: flex-end; border-bottom-right-radius: 3px; }
.them { background: var(--them-bg); align-items: flex-start; border-bottom-left-radius: 3px; }
.msg-text { line-height: 1.4; }
.msg-time { font-size: 10px; color: var(--text2); white-space: nowrap; }
.msg-media img, .msg-media video { max-width: 260px; max-height: 200px; border-radius: 8px; display: block; }
.msg-media audio { width: 220px; }

/* ‚îÄ‚îÄ Composer ‚îÄ‚îÄ */
.composer {
    display: flex;
    padding: 10px;
    border-top: 1px solid var(--border);
    gap: 6px;
    align-items: center;
    flex-shrink: 0;
}
.composer input { flex: 1; min-width: 0; }
#voiceBtn.recording { background: #fee2e2 !important; color: #dc2626 !important; }
#fileInput { display: none; }

/* ‚îÄ‚îÄ Typing in header ‚îÄ‚îÄ */
#typingIndicator { font-size: 12px; color: var(--accent); font-style: italic; font-weight: normal; }

/* ‚îÄ‚îÄ Logout / theme btn ‚îÄ‚îÄ */
#logoutBtn { font-size: 12px; padding: 4px 9px; }
#themeBtn { font-size: 16px; padding: 4px 7px; background: transparent; color: var(--text2); border-radius: 6px; }
#themeBtn:hover { background: var(--hover); }
.sidebar-actions { display: flex; gap: 4px; align-items: center; }

/* ‚îÄ‚îÄ callBox ‚îÄ‚îÄ */
.callBox {
    position: fixed; bottom: 20px; right: 20px;
    background: var(--panel); color: var(--text);
    padding: 14px 18px; border-radius: 14px;
    box-shadow: 0 8px 30px var(--shadow);
    display: none; flex-direction: column; gap: 8px;
    z-index: 300;
}
#callStatus { font-size: 13px; font-weight: 600; }

/* ‚îÄ‚îÄ Incoming call overlay ‚îÄ‚îÄ */
#incomingCall {
    position: fixed; inset: 0; background: rgba(0,0,0,.55);
    display: none; align-items: center; justify-content: center; z-index: 900;
}
#incomingBox {
    background: var(--panel); border-radius: 18px; padding: 28px 32px;
    box-shadow: 0 12px 40px rgba(0,0,0,.3); text-align: center;
    display: flex; flex-direction: column; gap: 14px; min-width: 240px;
}
#incomingBox .caller { font-size: 1.15rem; font-weight: bold; }
#incomingBox .sub { font-size: 13px; color: var(--text2); }
.call-btns { display: flex; gap: 10px; justify-content: center; }
#acceptCall { background: #16a34a; color: #fff; padding: 10px 22px; }
#acceptCall:hover { background: #15803d; }
#rejectCall { background: #dc2626; color: #fff; padding: 10px 22px; }
#rejectCall:hover { background: #b91c1c; }

/* ‚îÄ‚îÄ Auth overlay ‚îÄ‚îÄ */
#authOverlay {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000; transition: background .2s;
}
#authBox {
    background: var(--panel); border-radius: 16px; padding: 36px 30px;
    box-shadow: 0 12px 40px var(--shadow); width: min(340px, 92vw);
    display: flex; flex-direction: column; gap: 13px;
}
#authBox h2 { margin: 0; font-size: 1.4rem; }
#authBox input { width: 100%; }
#authBox .btn-primary { width: 100%; padding: 11px; font-size: 15px; }
#authError { color: #dc2626; font-size: 13px; min-height: 18px; }
#authSwitch { font-size: 13px; text-align: center; color: var(--text2); }
#authSwitch a { color: var(--accent); cursor: pointer; text-decoration: underline; }
.auth-theme-row { display: flex; justify-content: flex-end; }

/* ‚îÄ‚îÄ Context menu ‚îÄ‚îÄ */
#ctxMenu {
    position: fixed; background: var(--panel); border-radius: 10px;
    box-shadow: 0 4px 24px var(--shadow);
    padding: 4px 0; z-index: 500; display: none; min-width: 170px;
    border: 1px solid var(--border);
}
#ctxMenu button {
    display: block; width: 100%; text-align: left;
    padding: 9px 16px; background: none; border: none;
    font-size: 13px; cursor: pointer; border-radius: 0; color: var(--text);
}
#ctxMenu button:hover { background: var(--hover); }
#ctxMenu button.danger { color: #dc2626; }
#ctxMenu button.danger:hover { background: #fee2e2; }

/* ‚îÄ‚îÄ Mobile back button ‚îÄ‚îÄ */
#backBtn { display: none; }

/* ‚îÄ‚îÄ Mobile: single column ‚îÄ‚îÄ */
@media (max-width: 640px) {
    .app {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr;
        padding: 0;
        gap: 0;
    }
    .panel { border-radius: 0; box-shadow: none; }
    #sidebarPanel { display: flex; }
    #chatPanel { display: none; }
    .app.chat-open #sidebarPanel { display: none; }
    .app.chat-open #chatPanel { display: flex; }
    #backBtn { display: flex; }
    .msg-media img, .msg-media video { max-width: calc(100vw - 80px); }
    .callBox { bottom: 0; right: 0; left: 0; border-radius: 14px 14px 0 0; }
}
</style>
</head>

<body>

<!-- Auth -->
<div id="authOverlay">
  <div id="authBox">
    <div class="auth-theme-row">
      <button id="authThemeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">#themeBtn</button>
    </div>
    <h2 id="authTitle">–í—Ö–æ–¥</h2>
    <input id="authNick" placeholder="–ù–∏–∫" autocomplete="username">
    <input id="authPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
    <div id="authError"></div>
    <button class="btn-primary" id="authSubmit">–í–æ–π—Ç–∏</button>
    <div id="authSwitch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a id="authToggle">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></div>
  </div>
</div>

<!-- App -->
<div class="app" id="appDiv" style="display:none">

  <!-- Sidebar -->
  <div class="panel" id="sidebarPanel">
    <div class="top">
      <span class="top-title" id="myNickLabel">–í—ã: ‚Äî</span>
      <div class="sidebar-actions">
        <button id="themeBtn" title="–¢–µ–º–∞">üåô</button>
        <button class="btn-danger btn-icon" id="logoutBtn" title="–í—ã–π—Ç–∏">‚èª</button>
      </div>
    </div>
    <div class="add-friend-row">
      <input id="friendName" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ –Ω–∏–∫—É">
      <button class="btn-primary" id="addFriend">+</button>
    </div>
    <div class="contacts" id="contacts"></div>
  </div>

  <!-- Chat -->
  <div class="panel" id="chatPanel">
    <div class="top">
      <button class="btn-icon" id="backBtn">‚Üê</button>
      <span class="top-title" id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç<span id="typingIndicator"></span></span>
      <button class="btn-icon" id="callBtn" title="–ó–≤–æ–Ω–æ–∫">üìû</button>
    </div>
    <div class="messages" id="messages"></div>
    <div class="composer">
      <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
      <button class="btn-icon" id="attachBtn" title="–§–∞–π–ª">üìé</button>
      <input type="file" id="fileInput" accept="image/*,video/*,audio/*">
      <button class="btn-icon" id="voiceBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ">üé§</button>
      <button class="btn-primary" id="sendBtn">‚Üë</button>
    </div>
  </div>

</div>

<!-- Active call -->
<div class="callBox" id="callBox" style="display:none">
  <div id="callStatus">–ó–≤–æ–Ω–æ–∫...</div>
  <button class="btn-danger" id="endCall">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
</div>

<!-- Incoming call -->
<div id="incomingCall">
  <div id="incomingBox">
    <div class="caller" id="incomingCaller"></div>
    <div class="sub">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...</div>
    <div class="call-btns">
      <button id="acceptCall">–ü—Ä–∏–Ω—è—Ç—å</button>
      <button id="rejectCall">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Context menu -->
<div id="ctxMenu">
  <button id="ctxClear">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
  <button id="ctxDelete" class="danger">–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
</div>

<audio id="msgSound" src="message.mp3" preload="auto"></audio>
<audio id="callSound" src="call.mp3" preload="auto" loop></audio>

<script>
// ‚îÄ‚îÄ –¢–µ–º–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let theme = localStorage.getItem("theme") || "light";
function applyTheme(t) {
    theme = t;
    document.documentElement.setAttribute("data-theme", t);
    localStorage.setItem("theme", t);
    const icon = t === "dark" ? "‚òÄÔ∏è" : "üåô";
    document.querySelectorAll("#themeBtn, #authThemeBtn").forEach(b => b.textContent = icon);
}
applyTheme(theme);
document.getElementById("themeBtn").onclick = () => applyTheme(theme === "dark" ? "light" : "dark");
document.getElementById("authThemeBtn").onclick = () => applyTheme(theme === "dark" ? "light" : "dark");

// ‚îÄ‚îÄ –°–æ—Å—Ç–æ—è–Ω–∏–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let socket;
let myName = "";
let authMode = "login";
let state = JSON.parse(localStorage.getItem("messenger_state") ||
    '{"contacts":[],"conversations":{},"online":{},"unread":{},"lastMsg":{}}');
if (!state.unread) state.unread = {};
if (!state.lastMsg) state.lastMsg = {};
let active = null;

let peer, localStream;
let mediaRecorder = null, voiceChunks = [];
let pendingOffer = null;
const typingTimers = {};
let myTypingTimer = null, myTypingActive = false;

function save() { localStorage.setItem("messenger_state", JSON.stringify(state)); }

// ‚îÄ‚îÄ –°–µ—Å—Å–∏—è ‚Äî –∞–≤—Ç–æ–≤—Ö–æ–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const savedSession = JSON.parse(localStorage.getItem("session") || "null");
if (savedSession) {
    // –ü–æ–ø—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–π—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    document.getElementById("authNick").value = savedSession.nick;
    document.getElementById("authPassword").value = savedSession.password;
}

// ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const contactsEl    = document.getElementById("contacts");
const messagesEl    = document.getElementById("messages");
const chatHeader    = document.getElementById("chatHeader");
const typingIndicator = document.getElementById("typingIndicator");
const msgSound      = document.getElementById("msgSound");
const callBox       = document.getElementById("callBox");
const authOverlay   = document.getElementById("authOverlay");
const appDiv        = document.getElementById("appDiv");
const authError     = document.getElementById("authError");
const authTitle     = document.getElementById("authTitle");
const authSubmit    = document.getElementById("authSubmit");
const authToggle    = document.getElementById("authToggle");
const authSwitch    = document.getElementById("authSwitch");
const voiceBtn      = document.getElementById("voiceBtn");
const fileInput     = document.getElementById("fileInput");
const callSound     = document.getElementById("callSound");
const incomingCall  = document.getElementById("incomingCall");
const incomingCaller = document.getElementById("incomingCaller");
const appEl         = document.getElementById("appDiv");

// ‚îÄ‚îÄ –£—Ç–∏–ª–∏—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatTime(ts) {
    if (!ts) return "";
    const d = new Date(ts), now = new Date();
    const pad = n => String(n).padStart(2, "0");
    const time = pad(d.getHours()) + ":" + pad(d.getMinutes());
    if (d.toDateString() === now.toDateString()) return time;
    return pad(d.getDate()) + "." + pad(d.getMonth() + 1) + " " + time;
}

function b64toBlob(b64, type) {
    const bytes = atob(b64), arr = new Uint8Array(bytes.length);
    for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
    return new Blob([arr], { type });
}

// ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMessageEl(m) {
    const wrap = document.createElement("div");
    wrap.className = "message " + (m.from === myName ? "me" : "them");

    if (m.mediaType && m.mediaData) {
        const media = document.createElement("div");
        media.className = "msg-media";
        if (m.mediaType.startsWith("image/")) {
            const img = document.createElement("img");
            img.src = "data:" + m.mediaType + ";base64," + m.mediaData;
            img.alt = m.fileName || "image";
            media.appendChild(img);
        } else if (m.mediaType.startsWith("video/")) {
            const vid = document.createElement("video");
            vid.src = "data:" + m.mediaType + ";base64," + m.mediaData;
            vid.controls = true;
            media.appendChild(vid);
        } else if (m.mediaType.startsWith("audio/")) {
            const aud = document.createElement("audio");
            aud.src = "data:" + m.mediaType + ";base64," + m.mediaData;
            aud.controls = true;
            media.appendChild(aud);
        } else {
            const a = document.createElement("a");
            const blob = b64toBlob(m.mediaData, m.mediaType);
            a.href = URL.createObjectURL(blob);
            a.download = m.fileName || "file";
            a.textContent = "üìÑ " + (m.fileName || "file");
            a.style.cssText = "color:var(--accent);font-size:13px";
            media.appendChild(a);
        }
        wrap.appendChild(media);
    } else {
        const txt = document.createElement("span");
        txt.className = "msg-text";
        txt.textContent = m.text || "";
        wrap.appendChild(txt);
    }

    const time = document.createElement("span");
    time.className = "msg-time";
    time.textContent = formatTime(m.ts);
    wrap.appendChild(time);
    return wrap;
}

// ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderContacts() {
    contactsEl.innerHTML = "";
    const sorted = [...state.contacts].sort((a, b) => (state.lastMsg[b] || 0) - (state.lastMsg[a] || 0));
    sorted.forEach(name => {
        const d = document.createElement("div");
        d.className = "contact" + (name === active ? " active-contact" : "");

        const left = document.createElement("div");
        left.className = "contact-left";
        const nameEl = document.createElement("div");
        nameEl.className = "contact-name";
        nameEl.textContent = name;
        const typingEl = document.createElement("div");
        typingEl.className = "contact-typing";
        typingEl.textContent = typingTimers[name] ? "–ø–µ—á–∞—Ç–∞–µ—Ç..." : "";
        left.append(nameEl, typingEl);

        const right = document.createElement("div");
        right.className = "contact-right";
        const statusEl = document.createElement("span");
        statusEl.className = state.online[name] ? "status-online" : "status-offline";
        statusEl.textContent = state.online[name] ? "‚óè online" : "‚óè offline";
        right.appendChild(statusEl);
        const unread = state.unread[name] || 0;
        if (unread > 0) {
            const badge = document.createElement("div");
            badge.className = "unread-badge";
            badge.textContent = unread > 99 ? "99+" : unread;
            right.appendChild(badge);
        }

        d.append(left, right);
        d.onclick = () => openChat(name);
        d.oncontextmenu = e => { e.preventDefault(); showCtxMenu(e.clientX, e.clientY, name); };
        contactsEl.appendChild(d);
    });
}

function openChat(name) {
    active = name;
    state.unread[name] = 0;
    save();
    chatHeader.firstChild.textContent = "–ß–∞—Ç —Å " + name;
    typingIndicator.textContent = "";
    renderContacts();
    renderMessages();
    // mobile: switch to chat view
    appEl.classList.add("chat-open");
}

// ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMessages() {
    messagesEl.innerHTML = "";
    if (!active) return;
    (state.conversations[active] || []).forEach(m => messagesEl.appendChild(renderMessageEl(m)));
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

function appendMessage(m) {
    const peer = m.from === myName ? m.to : m.from;
    if (active === peer) {
        messagesEl.appendChild(renderMessageEl(m));
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
}

function sendMsg(msg) {
    if (!state.conversations[msg.to]) state.conversations[msg.to] = [];
    state.conversations[msg.to].push(msg);
    state.lastMsg[msg.to] = msg.ts || Date.now();
    socket.send(JSON.stringify(msg));
    save();
    appendMessage(msg);
    renderContacts();
}

// ‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mainMessageHandler(e) {
    let data;
    try { data = JSON.parse(e.data); } catch { return; }

    if (data.type === "kicked") {
        localStorage.removeItem("session");
        alert("–í—ã –≤–æ—à–ª–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.");
        location.reload();
        return;
    }

    if (data.type === "onlineList") {
        state.online = data.users;
        save(); renderContacts();
        return;
    }

    if (data.type === "typing") {
        const from = data.from;
        if (typingTimers[from]) clearTimeout(typingTimers[from]);
        typingTimers[from] = setTimeout(() => {
            delete typingTimers[from];
            renderContacts();
            if (active === from) typingIndicator.textContent = "";
        }, 3000);
        renderContacts();
        if (active === from) typingIndicator.textContent = " –ø–µ—á–∞—Ç–∞–µ—Ç...";
        return;
    }

    if (data.type === "message") {
        const from = data.from;
        if (typingTimers[from]) { clearTimeout(typingTimers[from]); delete typingTimers[from]; }
        if (active === from) typingIndicator.textContent = "";
        if (!state.conversations[from]) state.conversations[from] = [];
        state.conversations[from].push(data);
        if (!state.contacts.includes(from)) state.contacts.push(from);
        state.lastMsg[from] = data.ts || Date.now();
        if (active !== from) state.unread[from] = (state.unread[from] || 0) + 1;
        msgSound.play().catch(() => {});
        save(); renderContacts();
        appendMessage(data);
        return;
    }

    if (data.type === "signal") { handleSignal(data); }
}

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectAndAuth(nick, password) {
    authError.textContent = "";
    if (!nick || !password) { authError.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"; return; }
    authSubmit.disabled = true;

    const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host;
    socket = new WebSocket(wsUrl);

    socket.onopen = () => socket.send(JSON.stringify({ type: authMode, nick, password }));

    socket.onmessage = e => {
        let data;
        try { data = JSON.parse(e.data); } catch { return; }
        if (data.type !== "authResult") return;
        if (data.success) {
            myName = data.nick;
            // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
            localStorage.setItem("session", JSON.stringify({ nick, password }));
            document.getElementById("myNickLabel").textContent = "–í—ã: " + myName;
            authOverlay.style.display = "none";
            appDiv.style.display = "grid";
            socket.onmessage = mainMessageHandler;
            renderContacts();
        } else {
            authError.textContent = data.error || "–û—à–∏–±–∫–∞";
            authSubmit.disabled = false;
            socket.close();
            // –µ—Å–ª–∏ –∞–≤—Ç–æ–≤—Ö–æ–¥ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è ‚Äî —É–±–∏—Ä–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            localStorage.removeItem("session");
        }
    };

    socket.onerror = () => {
        authError.textContent = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
        authSubmit.disabled = false;
    };
}

authSubmit.onclick = () => connectAndAuth(
    document.getElementById("authNick").value.trim(),
    document.getElementById("authPassword").value
);
["authNick","authPassword"].forEach(id =>
    document.getElementById(id).addEventListener("keydown", e => {
        if (e.key === "Enter") authSubmit.click();
    })
);

authToggle.onclick = () => {
    if (authMode === "login") {
        authMode = "register";
        authTitle.textContent = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
        authSubmit.textContent = "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è";
        authSwitch.innerHTML = '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a id="authToggle">–í–æ–π—Ç–∏</a>';
    } else {
        authMode = "login";
        authTitle.textContent = "–í—Ö–æ–¥";
        authSubmit.textContent = "–í–æ–π—Ç–∏";
        authSwitch.innerHTML = '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a id="authToggle">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>';
    }
    authError.textContent = "";
    document.getElementById("authToggle").onclick = authToggle.onclick;
};

// –∞–≤—Ç–æ–≤—Ö–æ–¥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
if (savedSession) {
    connectAndAuth(savedSession.nick, savedSession.password);
}

// ‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("sendBtn").onclick = () => {
    if (!active) return;
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;
    sendMsg({ type: "message", from: myName, to: active, text, ts: Date.now() });
    document.getElementById("messageInput").value = "";
    myTypingActive = false;
};
document.getElementById("messageInput").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); document.getElementById("sendBtn").click(); return; }
    if (!active || !socket) return;
    if (!myTypingActive) {
        myTypingActive = true;
        socket.send(JSON.stringify({ type: "typing", from: myName, to: active }));
    }
    clearTimeout(myTypingTimer);
    myTypingTimer = setTimeout(() => { myTypingActive = false; }, 2500);
});

// ‚îÄ‚îÄ –§–∞–π–ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("attachBtn").onclick = () => { if (active) fileInput.click(); };
fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return;
    fileInput.value = "";
    if (file.size > 10 * 1024 * 1024) { alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10 –ú–ë)"); return; }
    const reader = new FileReader();
    reader.onload = ev => sendMsg({
        type: "message", from: myName, to: active, text: "",
        mediaType: file.type, mediaData: ev.target.result.split(",")[1],
        fileName: file.name, ts: Date.now()
    });
    reader.readAsDataURL(file);
};

// ‚îÄ‚îÄ –ì–æ–ª–æ—Å–æ–≤–æ–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
voiceBtn.onclick = async () => {
    if (!active) return;
    if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.stop(); return; }
    let stream;
    try { stream = await navigator.mediaDevices.getUserMedia({ audio: true }); }
    catch { alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"); return; }
    voiceChunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => voiceChunks.push(e.data);
    mediaRecorder.onstop = () => {
        stream.getTracks().forEach(t => t.stop());
        voiceBtn.classList.remove("recording");
        const blob = new Blob(voiceChunks, { type: mediaRecorder.mimeType || "audio/webm" });
        const reader = new FileReader();
        reader.onload = ev => sendMsg({
            type: "message", from: myName, to: active, text: "",
            mediaType: blob.type, mediaData: ev.target.result.split(",")[1],
            fileName: "voice.webm", ts: Date.now()
        });
        reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    voiceBtn.classList.add("recording");
};

// ‚îÄ‚îÄ –í—ã–π—Ç–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("logoutBtn").onclick = () => {
    localStorage.removeItem("session");
    if (socket) socket.close();
    location.reload();
};

// ‚îÄ‚îÄ –ù–∞–∑–∞–¥ (–º–æ–±–∏–ª—å–Ω—ã–π) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("backBtn").onclick = () => {
    appEl.classList.remove("chat-open");
    active = null;
};

// ‚îÄ‚îÄ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ctxMenu = document.getElementById("ctxMenu");
let ctxTarget = null;
function showCtxMenu(x, y, name) {
    ctxTarget = name;
    // –Ω–µ –≤—ã–ª–µ–∑–∞—Ç—å –∑–∞ –∫—Ä–∞–π —ç–∫—Ä–∞–Ω–∞
    const mw = 170, mh = 80;
    ctxMenu.style.left = Math.min(x, window.innerWidth - mw - 8) + "px";
    ctxMenu.style.top  = Math.min(y, window.innerHeight - mh - 8) + "px";
    ctxMenu.style.display = "block";
}
function hideCtxMenu() { ctxMenu.style.display = "none"; ctxTarget = null; }
document.addEventListener("click", hideCtxMenu);
document.addEventListener("keydown", e => { if (e.key === "Escape") hideCtxMenu(); });

document.getElementById("ctxClear").onclick = () => {
    if (!ctxTarget) return;
    state.conversations[ctxTarget] = [];
    save();
    if (active === ctxTarget) renderMessages();
    hideCtxMenu();
};
document.getElementById("ctxDelete").onclick = () => {
    if (!ctxTarget) return;
    state.contacts = state.contacts.filter(c => c !== ctxTarget);
    delete state.conversations[ctxTarget];
    delete state.unread[ctxTarget];
    delete state.lastMsg[ctxTarget];
    if (active === ctxTarget) {
        active = null;
        chatHeader.firstChild.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç";
        typingIndicator.textContent = "";
        renderMessages();
        appEl.classList.remove("chat-open");
    }
    save(); renderContacts();
    hideCtxMenu();
};

// ‚îÄ‚îÄ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("addFriend").onclick = () => {
    const f = document.getElementById("friendName").value.trim();
    if (!f) return;
    if (!state.contacts.includes(f)) state.contacts.push(f);
    document.getElementById("friendName").value = "";
    save(); renderContacts();
};
document.getElementById("friendName").addEventListener("keydown", e => {
    if (e.key === "Enter") document.getElementById("addFriend").click();
});

// ‚îÄ‚îÄ –ó–≤–æ–Ω–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stopCallSound() { callSound.pause(); callSound.currentTime = 0; }
function endActiveCall() {
    if (peer) { peer.close(); peer = null; }
    if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
    stopCallSound();
    callBox.style.display = "none";
}

async function startCall() {
    if (!active) return;
    peer = createPeer(active);
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);
    socket.send(JSON.stringify({ type: "signal", from: myName, to: active, data: offer }));
    document.getElementById("callStatus").textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...";
    callBox.style.display = "flex";
}

function createPeer(callTarget) {
    const pc = new RTCPeerConnection();
    pc.onicecandidate = e => {
        if (e.candidate)
            socket.send(JSON.stringify({ type: "signal", from: myName, to: callTarget, data: e.candidate }));
    };
    pc.ontrack = e => { const a = new Audio(); a.srcObject = e.streams[0]; a.play(); };
    pc.onconnectionstatechange = () => {
        if (pc.connectionState === "connected")
            document.getElementById("callStatus").textContent = "–ó–≤–æ–Ω–æ–∫ —Å " + callTarget;
    };
    return pc;
}

async function handleSignal(data) {
    if (data.data.type === "offer") {
        pendingOffer = data;
        incomingCaller.textContent = data.from;
        incomingCall.style.display = "flex";
        callSound.play().catch(() => {});
    } else if (data.data.type === "answer") {
        if (!peer) return;
        stopCallSound();
        await peer.setRemoteDescription(new RTCSessionDescription(data.data));
        document.getElementById("callStatus").textContent = "–ó–≤–æ–Ω–æ–∫...";
    } else if (data.data === "rejected") {
        stopCallSound(); endActiveCall();
        document.getElementById("callStatus").textContent = "–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω";
    } else {
        if (peer) try { await peer.addIceCandidate(new RTCIceCandidate(data.data)); } catch {}
    }
}

document.getElementById("acceptCall").onclick = async () => {
    if (!pendingOffer) return;
    const data = pendingOffer; pendingOffer = null;
    incomingCall.style.display = "none";
    stopCallSound();
    active = data.from;
    chatHeader.firstChild.textContent = "–ß–∞—Ç —Å " + active;
    typingIndicator.textContent = "";
    appEl.classList.add("chat-open");
    renderContacts(); renderMessages();
    peer = createPeer(data.from);
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
    await peer.setRemoteDescription(new RTCSessionDescription(data.data));
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    socket.send(JSON.stringify({ type: "signal", from: myName, to: data.from, data: answer }));
    document.getElementById("callStatus").textContent = "–ó–≤–æ–Ω–æ–∫ —Å " + data.from;
    callBox.style.display = "flex";
};

document.getElementById("rejectCall").onclick = () => {
    if (!pendingOffer) return;
    const from = pendingOffer.from; pendingOffer = null;
    incomingCall.style.display = "none";
    stopCallSound();
    socket.send(JSON.stringify({ type: "signal", from: myName, to: from, data: "rejected" }));
};

document.getElementById("callBtn").onclick = startCall;
document.getElementById("endCall").onclick = endActiveCall;

// ‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderContacts();
</script>
</body>
</html>
