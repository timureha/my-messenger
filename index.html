<!doctype html>
<html lang="ru" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Messenger PRO</title>
<style>
/* ‚îÄ‚îÄ –¢–µ–º—ã ‚îÄ‚îÄ */
:root {
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --bg: #f3f4f6;
    --panel: #ffffff;
    --border: #e5e7eb;
    --text: #111827;
    --text2: #6b7280;
    --me-bg: #dbeafe;
    --them-bg: #f1f5f9;
    --input-bg: #ffffff;
    --input-border: #d1d5db;
    --hover: #f9fafb;
    --shadow: rgba(0,0,0,.08);
    --topbar-bg: #ffffff;
}
[data-theme="dark"] {
    --bg: #0f172a;
    --panel: #1e293b;
    --border: #334155;
    --text: #f1f5f9;
    --text2: #94a3b8;
    --me-bg: #1e40af;
    --them-bg: #334155;
    --input-bg: #1e293b;
    --input-border: #475569;
    --hover: #263148;
    --shadow: rgba(0,0,0,.3);
    --topbar-bg: #1e293b;
}

/* ‚îÄ‚îÄ Reset ‚îÄ‚îÄ */
*, *::before, *::after { box-sizing: border-box; }
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
    font-size: 14px;
    background: var(--bg);
    color: var(--text);
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: background .2s, color .2s;
}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.app {
    display: grid;
    grid-template-columns: 300px 1fr;
    flex: 1;
    min-height: 0;
    gap: 10px;
    padding: 10px;
}
.panel {
    background: var(--panel);
    border-radius: 12px;
    box-shadow: 0 4px 20px var(--shadow);
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
    transition: background .2s;
}

/* ‚îÄ‚îÄ Top bars ‚îÄ‚îÄ */
.top {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    background: var(--topbar-bg);
    transition: background .2s, border-color .2s;
}
.top-title { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ‚îÄ‚îÄ Inputs & Buttons ‚îÄ‚îÄ */
input, textarea {
    padding: 9px 12px;
    border-radius: 8px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    outline: none;
    transition: border-color .15s, background .2s;
}
input:focus { border-color: var(--accent); }
button {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-family: inherit;
    transition: background .15s, opacity .15s;
}
button:active { opacity: .8; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-icon {
    font-size: 18px;
    padding: 6px 9px;
    background: transparent;
    color: var(--text2);
    border-radius: 8px;
}
.btn-icon:hover { background: var(--hover); color: var(--text); }
.btn-danger { background: #fee2e2; color: #dc2626; }
.btn-danger:hover { background: #fecaca; }

/* ‚îÄ‚îÄ Add friend row ‚îÄ‚îÄ */
.add-friend-row {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 6px;
    flex-shrink: 0;
}
.add-friend-row input { flex: 1; }

/* ‚îÄ‚îÄ Contacts ‚îÄ‚îÄ */
.contacts { flex: 1; overflow-y: auto; }
.contact {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    transition: background .12s;
}
.contact:hover { background: var(--hover); }
.contact.active-contact { background: var(--me-bg); }
.contact-left { display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 0; }
.contact-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.contact-typing { font-size: 11px; color: var(--accent); font-style: italic; height: 14px; }
.contact-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
.status-online { color: #16a34a; font-size: 11px; }
.status-offline { color: var(--text2); font-size: 11px; }
.unread-badge {
    background: #dc2626; color: #fff; border-radius: 999px;
    font-size: 11px; font-weight: 700;
    min-width: 18px; height: 18px;
    display: flex; align-items: center; justify-content: center;
    padding: 0 5px;
}

/* ‚îÄ‚îÄ Chat panel ‚îÄ‚îÄ */
.messages {
    flex: 1;
    padding: 14px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.message {
    max-width: 72%;
    padding: 8px 11px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 3px;
    word-break: break-word;
}
.me { background: var(--me-bg); margin-left: auto; align-items: flex-end; border-bottom-right-radius: 3px; }
.them { background: var(--them-bg); align-items: flex-start; border-bottom-left-radius: 3px; }
.msg-text { line-height: 1.4; }
.msg-time { font-size: 10px; color: var(--text2); white-space: nowrap; }
.msg-media img, .msg-media video { max-width: 260px; max-height: 200px; border-radius: 8px; display: block; }
.msg-media audio { width: 220px; }

/* ‚îÄ‚îÄ Composer ‚îÄ‚îÄ */
.composer {
    display: flex;
    padding: 10px;
    border-top: 1px solid var(--border);
    gap: 6px;
    align-items: center;
    flex-shrink: 0;
}
.composer input { flex: 1; min-width: 0; }
#voiceBtn.recording { background: #fee2e2 !important; color: #dc2626 !important; }
#fileInput { display: none; }

/* ‚îÄ‚îÄ Typing in header ‚îÄ‚îÄ */
#typingIndicator { font-size: 12px; color: var(--accent); font-style: italic; font-weight: normal; }

/* ‚îÄ‚îÄ Logout / theme btn ‚îÄ‚îÄ */
#logoutBtn { font-size: 12px; padding: 4px 9px; }
#themeBtn { font-size: 16px; padding: 4px 7px; background: transparent; color: var(--text2); border-radius: 6px; }
#themeBtn:hover { background: var(--hover); }
.sidebar-actions { display: flex; gap: 4px; align-items: center; }

/* ‚îÄ‚îÄ callBox ‚îÄ‚îÄ */
.callBox {
    position: fixed; bottom: 20px; right: 20px;
    background: var(--panel); color: var(--text);
    padding: 14px 18px; border-radius: 14px;
    box-shadow: 0 8px 30px var(--shadow);
    display: none; flex-direction: column; gap: 8px;
    z-index: 300;
}
#callStatus { font-size: 13px; font-weight: 600; }

/* ‚îÄ‚îÄ Incoming call overlay ‚îÄ‚îÄ */
#incomingCall {
    position: fixed; inset: 0; background: rgba(0,0,0,.55);
    display: none; align-items: center; justify-content: center; z-index: 900;
}
#incomingBox {
    background: var(--panel); border-radius: 18px; padding: 28px 32px;
    box-shadow: 0 12px 40px rgba(0,0,0,.3); text-align: center;
    display: flex; flex-direction: column; gap: 14px; min-width: 240px;
}
#incomingBox .caller { font-size: 1.15rem; font-weight: bold; }
#incomingBox .sub { font-size: 13px; color: var(--text2); }
.call-btns { display: flex; gap: 10px; justify-content: center; }
#acceptCall { background: #16a34a; color: #fff; padding: 10px 22px; }
#acceptCall:hover { background: #15803d; }
#rejectCall { background: #dc2626; color: #fff; padding: 10px 22px; }
#rejectCall:hover { background: #b91c1c; }

/* ‚îÄ‚îÄ Auth overlay ‚îÄ‚îÄ */
#authOverlay {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000; transition: background .2s;
}
#authBox {
    background: var(--panel); border-radius: 16px; padding: 36px 30px;
    box-shadow: 0 12px 40px var(--shadow); width: min(340px, 92vw);
    display: flex; flex-direction: column; gap: 13px;
}
#authBox h2 { margin: 0; font-size: 1.4rem; }
#authBox input { width: 100%; }
#authBox .btn-primary { width: 100%; padding: 11px; font-size: 15px; }
#authError { color: #dc2626; font-size: 13px; min-height: 18px; }
#authSwitch { font-size: 13px; text-align: center; color: var(--text2); }
#authSwitch a { color: var(--accent); cursor: pointer; text-decoration: underline; }
.auth-theme-row { display: flex; justify-content: flex-end; }

/* ‚îÄ‚îÄ Context menu ‚îÄ‚îÄ */
#ctxMenu {
    position: fixed; background: var(--panel); border-radius: 10px;
    box-shadow: 0 4px 24px var(--shadow);
    padding: 4px 0; z-index: 500; display: none; min-width: 170px;
    border: 1px solid var(--border);
}
#ctxMenu button {
    display: block; width: 100%; text-align: left;
    padding: 9px 16px; background: none; border: none;
    font-size: 13px; cursor: pointer; border-radius: 0; color: var(--text);
}
#ctxMenu button:hover { background: var(--hover); }
#ctxMenu button.danger { color: #dc2626; }
#ctxMenu button.danger:hover { background: #fee2e2; }

/* ‚îÄ‚îÄ Message context menu ‚îÄ‚îÄ */
#msgCtxMenu {
    position: fixed; background: var(--panel); border-radius: 10px;
    box-shadow: 0 4px 24px var(--shadow);
    padding: 4px 0; z-index: 600; display: none; min-width: 160px;
    border: 1px solid var(--border);
}
#msgCtxMenu button {
    display: block; width: 100%; text-align: left;
    padding: 9px 16px; background: none; border: none;
    font-size: 13px; cursor: pointer; border-radius: 0; color: var(--text);
}
#msgCtxMenu button:hover { background: var(--hover); }
#msgCtxMenu button.danger { color: #dc2626; }
#msgCtxMenu button.danger:hover { background: #fee2e2; }

/* ‚îÄ‚îÄ Edit bar (replaces composer input when editing) ‚îÄ‚îÄ */
#editBar {
    display: none;
    padding: 6px 10px;
    background: var(--hover);
    border-top: 1px solid var(--border);
    font-size: 12px;
    color: var(--text2);
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}
#editBar span { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
#editCancelBtn { font-size: 16px; padding: 2px 6px; background: none; color: var(--text2); }
#editCancelBtn:hover { color: var(--text); }

/* ‚îÄ‚îÄ Deleted / edited message ‚îÄ‚îÄ */
.msg-deleted { color: var(--text2); font-style: italic; }
.msg-edited { font-size: 10px; color: var(--text2); }

/* ‚îÄ‚îÄ Read status ticks ‚îÄ‚îÄ */
.msg-ticks { font-size: 12px; margin-left: 3px; color: var(--text2); }
.msg-ticks.read { color: #2563eb; }

/* ‚îÄ‚îÄ Last seen in chat header ‚îÄ‚îÄ */
#lastSeenLabel { font-size: 11px; color: var(--text2); font-weight: normal; display: block; line-height: 1.2; }

/* ‚îÄ‚îÄ Read receipts in group (avatars/nicks under message) ‚îÄ‚îÄ */
.msg-read-by { font-size: 10px; color: var(--text2); margin-top: 1px; }

/* ‚îÄ‚îÄ Reply quote inside message ‚îÄ‚îÄ */
.msg-reply-quote {
    border-left: 3px solid var(--accent);
    padding: 3px 8px;
    margin-bottom: 4px;
    background: rgba(37,99,235,.08);
    border-radius: 0 6px 6px 0;
    cursor: pointer;
    max-width: 100%;
}
.msg-reply-quote:hover { background: rgba(37,99,235,.15); }
.msg-reply-author { font-size: 11px; font-weight: 600; color: var(--accent); }
.msg-reply-text { font-size: 12px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 220px; }

/* ‚îÄ‚îÄ Reply bar above composer ‚îÄ‚îÄ */
#replyBar {
    display: none;
    padding: 6px 10px;
    background: var(--hover);
    border-top: 1px solid var(--border);
    font-size: 12px;
    color: var(--text2);
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}
#replyBar .reply-bar-inner { flex: 1; overflow: hidden; }
#replyBar .reply-bar-author { font-size: 11px; font-weight: 600; color: var(--accent); }
#replyBar .reply-bar-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#replyCancelBtn { font-size: 16px; padding: 2px 6px; background: none; color: var(--text2); }
#replyCancelBtn:hover { color: var(--text); }

/* ‚îÄ‚îÄ Forward label inside message ‚îÄ‚îÄ */
.msg-forward-label {
    font-size: 11px; color: var(--accent); font-style: italic;
    border-left: 2px solid var(--accent); padding-left: 6px;
    margin-bottom: 3px;
}

/* ‚îÄ‚îÄ Forward modal ‚îÄ‚îÄ */
#forwardModal {
    position: fixed; inset: 0; background: rgba(0,0,0,.5);
    display: none; align-items: center; justify-content: center; z-index: 810;
}
#forwardBox {
    background: var(--panel); border-radius: 16px; padding: 22px 20px;
    box-shadow: 0 12px 40px var(--shadow); width: min(340px, 94vw);
    display: flex; flex-direction: column; gap: 10px;
}
#forwardBox h3 { margin: 0; font-size: 1.05rem; }
#forwardSearch { width: 100%; }
#forwardList { display: flex; flex-direction: column; gap: 2px; max-height: 240px; overflow-y: auto; }
.forward-item {
    padding: 8px 10px; border-radius: 8px; cursor: pointer;
    font-size: 13px; display: flex; align-items: center; gap: 6px;
    transition: background .1s;
}
.forward-item:hover { background: var(--hover); }

/* ‚îÄ‚îÄ Emoji reaction picker (inside context menu) ‚îÄ‚îÄ */
.reaction-picker {
    display: flex; gap: 4px; padding: 6px 10px 4px;
    flex-wrap: wrap; max-width: 220px;
}
.reaction-picker button {
    font-size: 20px; padding: 3px 5px; border-radius: 6px;
    background: none; line-height: 1;
}
.reaction-picker button:hover { background: var(--hover); }

/* ‚îÄ‚îÄ Reactions row under message ‚îÄ‚îÄ */
.msg-reactions {
    display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;
}
.reaction-chip {
    display: flex; align-items: center; gap: 3px;
    background: var(--hover); border: 1px solid var(--border);
    border-radius: 999px; padding: 2px 7px; font-size: 13px;
    cursor: pointer; user-select: none; transition: background .12s;
}
.reaction-chip:hover { background: var(--me-bg); }
.reaction-chip.mine { background: var(--me-bg); border-color: var(--accent); }
.reaction-chip .rc-count { font-size: 11px; color: var(--text2); }

/* ‚îÄ‚îÄ New group button ‚îÄ‚îÄ */
#newGroupBtn {
    font-size: 18px; padding: 6px 9px;
    background: transparent; color: var(--text2); border-radius: 8px;
}
#newGroupBtn:hover { background: var(--hover); color: var(--text); }

/* ‚îÄ‚îÄ Group modal overlay ‚îÄ‚îÄ */
#groupModal {
    position: fixed; inset: 0; background: rgba(0,0,0,.5);
    display: none; align-items: center; justify-content: center; z-index: 800;
}
#groupBox {
    background: var(--panel); border-radius: 16px; padding: 28px 26px;
    box-shadow: 0 12px 40px var(--shadow); width: min(360px, 94vw);
    display: flex; flex-direction: column; gap: 12px;
}
#groupBox h3 { margin: 0; font-size: 1.1rem; }
#groupBox input { width: 100%; }
#groupMembersList {
    display: flex; flex-direction: column; gap: 6px;
    max-height: 160px; overflow-y: auto;
}
.group-member-row {
    display: flex; align-items: center; gap: 8px;
    padding: 5px 8px; border-radius: 8px;
    border: 1px solid var(--border); background: var(--hover);
    font-size: 13px;
}
.group-member-row .remove-member {
    margin-left: auto; background: none; padding: 2px 6px;
    color: #dc2626; font-size: 14px; border-radius: 6px;
}
.group-member-row .remove-member:hover { background: #fee2e2; }
#groupModalError { color: #dc2626; font-size: 12px; min-height: 16px; }
.group-modal-btns { display: flex; gap: 8px; justify-content: flex-end; }

/* ‚îÄ‚îÄ Group badge in contacts ‚îÄ‚îÄ */
.contact-group-icon { font-size: 11px; color: var(--text2); margin-right: 3px; }

/* ‚îÄ‚îÄ Message sender name (in groups) ‚îÄ‚îÄ */
.msg-sender { font-size: 11px; font-weight: 600; color: var(--accent); margin-bottom: 1px; }

/* ‚îÄ‚îÄ Mobile back button ‚îÄ‚îÄ */
#backBtn { display: none; }

/* ‚îÄ‚îÄ Mobile: single column ‚îÄ‚îÄ */
@media (max-width: 640px) {
    .app {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr;
        padding: 0;
        gap: 0;
    }
    .panel { border-radius: 0; box-shadow: none; }
    #sidebarPanel { display: flex; }
    #chatPanel { display: none; }
    .app.chat-open #sidebarPanel { display: none; }
    .app.chat-open #chatPanel { display: flex; }
    #backBtn { display: flex; }
    .msg-media img, .msg-media video { max-width: calc(100vw - 80px); }
    .callBox { bottom: 0; right: 0; left: 0; border-radius: 14px 14px 0 0; }
}
</style>
</head>

<body>

<!-- Auth -->
<div id="authOverlay">
  <div id="authBox">
    <div class="auth-theme-row">
      <button id="authThemeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">#themeBtn</button>
    </div>
    <h2 id="authTitle">–í—Ö–æ–¥</h2>
    <input id="authNick" placeholder="–ù–∏–∫" autocomplete="username">
    <input id="authPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
    <div id="authError"></div>
    <button class="btn-primary" id="authSubmit">–í–æ–π—Ç–∏</button>
    <div id="authSwitch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a id="authToggle">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></div>
  </div>
</div>

<!-- App -->
<div class="app" id="appDiv" style="display:none">

  <!-- Sidebar -->
  <div class="panel" id="sidebarPanel">
    <div class="top">
      <span class="top-title" id="myNickLabel">–í—ã: ‚Äî</span>
      <div class="sidebar-actions">
        <button id="newGroupBtn" title="–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É">üë•</button>
        <button id="themeBtn" title="–¢–µ–º–∞">üåô</button>
        <button class="btn-danger btn-icon" id="logoutBtn" title="–í—ã–π—Ç–∏">‚èª</button>
      </div>
    </div>
    <div class="add-friend-row">
      <input id="friendName" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ –Ω–∏–∫—É">
      <button class="btn-primary" id="addFriend">+</button>
    </div>
    <div class="contacts" id="contacts"></div>
  </div>

  <!-- Chat -->
  <div class="panel" id="chatPanel">
    <div class="top">
      <button class="btn-icon" id="backBtn">‚Üê</button>
      <span class="top-title" id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç<span id="typingIndicator"></span><span id="lastSeenLabel"></span></span>
      <button class="btn-icon" id="addMemberBtn" title="–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞" style="display:none">‚ûï</button>
      <button class="btn-icon" id="callBtn" title="–ó–≤–æ–Ω–æ–∫">üìû</button>
    </div>
    <div class="messages" id="messages"></div>
    <div id="replyBar">
      <div class="reply-bar-inner">
        <div class="reply-bar-author" id="replyBarAuthor"></div>
        <div class="reply-bar-text" id="replyBarText"></div>
      </div>
      <button id="replyCancelBtn" title="–û—Ç–º–µ–Ω–∞">‚úï</button>
    </div>
    <div id="editBar">
      <span id="editBarText"></span>
      <button id="editCancelBtn" title="–û—Ç–º–µ–Ω–∞">‚úï</button>
    </div>
    <div class="composer">
      <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
      <button class="btn-icon" id="attachBtn" title="–§–∞–π–ª">üìé</button>
      <input type="file" id="fileInput" accept="image/*,video/*,audio/*">
      <button class="btn-icon" id="voiceBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ">üé§</button>
      <button class="btn-primary" id="sendBtn">‚Üë</button>
    </div>
  </div>

</div>

<!-- Group create modal -->
<div id="groupModal">
  <div id="groupBox">
    <h3>–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</h3>
    <input id="groupNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–º–∞–∫—Å. 64 —Å–∏–º–≤–æ–ª–∞)">
    <div style="display:flex;gap:6px">
      <input id="groupMemberInput" placeholder="–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ –Ω–∏–∫—É" style="flex:1">
      <button class="btn-primary" id="groupAddMemberBtn">+</button>
    </div>
    <div id="groupMembersList"></div>
    <div id="groupModalError"></div>
    <div class="group-modal-btns">
      <button id="groupCancelBtn">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-primary" id="groupCreateBtn">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- Add member modal -->
<div id="addMemberModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:800">
  <div style="background:var(--panel);border-radius:16px;padding:24px 22px;box-shadow:0 12px 40px var(--shadow);width:min(320px,92vw);display:flex;flex-direction:column;gap:12px">
    <h3 style="margin:0;font-size:1.1rem">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
    <div style="display:flex;gap:6px">
      <input id="addMemberNickInput" placeholder="–ù–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="flex:1">
      <button class="btn-primary" id="addMemberConfirmBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="addMemberError" style="color:#dc2626;font-size:12px;min-height:16px"></div>
    <div style="display:flex;justify-content:flex-end">
      <button id="addMemberCancelBtn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- Active call -->
<div class="callBox" id="callBox" style="display:none">
  <div id="callStatus">–ó–≤–æ–Ω–æ–∫...</div>
  <button class="btn-danger" id="endCall">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
</div>

<!-- Incoming call -->
<div id="incomingCall">
  <div id="incomingBox">
    <div class="caller" id="incomingCaller"></div>
    <div class="sub">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...</div>
    <div class="call-btns">
      <button id="acceptCall">–ü—Ä–∏–Ω—è—Ç—å</button>
      <button id="rejectCall">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Message context menu -->
<div id="msgCtxMenu">
  <div class="reaction-picker" id="reactionPicker">
    <button data-emoji="üëç">üëç</button>
    <button data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
    <button data-emoji="üòÇ">üòÇ</button>
    <button data-emoji="üòÆ">üòÆ</button>
    <button data-emoji="üò¢">üò¢</button>
    <button data-emoji="üî•">üî•</button>
    <button data-emoji="üëé">üëé</button>
    <button data-emoji="üéâ">üéâ</button>
  </div>
  <div style="height:1px;background:var(--border);margin:2px 0"></div>
  <button id="msgCtxReply">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
  <button id="msgCtxForward">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</button>
  <button id="msgCtxEdit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
  <button id="msgCtxDelete" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
</div>

<!-- Forward modal -->
<div id="forwardModal">
  <div id="forwardBox">
    <h3>–ü–µ—Ä–µ—Å–ª–∞—Ç—å –≤...</h3>
    <input id="forwardSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º">
    <div id="forwardList"></div>
    <div style="display:flex;justify-content:flex-end">
      <button id="forwardCancelBtn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- Context menu -->
<div id="ctxMenu">
  <button id="ctxClear">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
  <button id="ctxDelete" class="danger">–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
  <button id="ctxLeaveGroup" class="danger" style="display:none">–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</button>
</div>

<audio id="msgSound" src="message.mp3" preload="auto"></audio>
<audio id="callSound" src="call.mp3" preload="auto" loop></audio>

<script>
// ‚îÄ‚îÄ –¢–µ–º–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let theme = localStorage.getItem("theme") || "light";
function applyTheme(t) {
    theme = t;
    document.documentElement.setAttribute("data-theme", t);
    localStorage.setItem("theme", t);
    const icon = t === "dark" ? "‚òÄÔ∏è" : "üåô";
    document.querySelectorAll("#themeBtn, #authThemeBtn").forEach(b => b.textContent = icon);
}
applyTheme(theme);
document.getElementById("themeBtn").onclick = () => applyTheme(theme === "dark" ? "light" : "dark");
document.getElementById("authThemeBtn").onclick = () => applyTheme(theme === "dark" ? "light" : "dark");

// ‚îÄ‚îÄ –°–æ—Å—Ç–æ—è–Ω–∏–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let socket;
let myName = "";
let authMode = "login";
let state = JSON.parse(localStorage.getItem("messenger_state") ||
    '{"contacts":[],"conversations":{},"online":{},"unread":{},"lastMsg":{},"groups":{},"readStatus":{},"groupReadBy":{},"lastSeen":{}}');
if (!state.unread) state.unread = {};
if (!state.lastMsg) state.lastMsg = {};
if (!state.groups) state.groups = {};
if (!state.readStatus) state.readStatus = {};   // convKey -> lastReadId (–ø—Ä–æ—á–∏—Ç–∞–Ω–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º)
if (!state.groupReadBy) state.groupReadBy = {}; // msgId -> [nick, ...]
if (!state.lastSeen) state.lastSeen = {};       // nick -> timestamp
if (!state.reactions) state.reactions = {};     // msgId -> { emoji: [nick, ...], ... }
let active = null;

let peer, localStream;
let mediaRecorder = null, voiceChunks = [];
let pendingOffer = null;
const typingTimers = {};
let myTypingTimer = null, myTypingActive = false;

function save() { localStorage.setItem("messenger_state", JSON.stringify(state)); }

// –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±–ª–∞—Å—Ç–∏ —á–∞—Ç–∞
function showSystemMsg(text) {
    const el = document.createElement("div");
    el.style.cssText = "text-align:center;font-size:12px;color:var(--text2);padding:6px 12px;";
    el.textContent = text;
    messagesEl.appendChild(el);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// –û—á–µ—Ä–µ–¥—å –∫–æ–ª–±—ç–∫–æ–≤ –æ–∂–∏–¥–∞—é—â–∏—Ö –æ—Ç–≤–µ—Ç–∞ nickResult: { [nick]: [fn, ...] }
const nickCallbacks = {};

// –¢–µ–∫—É—â–µ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: { conv, idx } –∏–ª–∏ null
let editingMsg = null;
let replyingTo = null; // –æ–±—ä–µ–∫—Ç { id, from, text, mediaType }

// ‚îÄ‚îÄ –°–µ—Å—Å–∏—è ‚Äî –∞–≤—Ç–æ–≤—Ö–æ–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const savedSession = JSON.parse(localStorage.getItem("session") || "null");
if (savedSession) {
    // –ü–æ–ø—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–π—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    document.getElementById("authNick").value = savedSession.nick;
    document.getElementById("authPassword").value = savedSession.password;
}

// ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const contactsEl    = document.getElementById("contacts");
const messagesEl    = document.getElementById("messages");
const chatHeader    = document.getElementById("chatHeader");
const typingIndicator = document.getElementById("typingIndicator");
const msgSound      = document.getElementById("msgSound");
const callBox       = document.getElementById("callBox");
const authOverlay   = document.getElementById("authOverlay");
const appDiv        = document.getElementById("appDiv");
const authError     = document.getElementById("authError");
const authTitle     = document.getElementById("authTitle");
const authSubmit    = document.getElementById("authSubmit");
const authToggle    = document.getElementById("authToggle");
const authSwitch    = document.getElementById("authSwitch");
const voiceBtn      = document.getElementById("voiceBtn");
const fileInput     = document.getElementById("fileInput");
const callSound     = document.getElementById("callSound");
const incomingCall  = document.getElementById("incomingCall");
const incomingCaller = document.getElementById("incomingCaller");
const appEl         = document.getElementById("appDiv");
const lastSeenLabel = document.getElementById("lastSeenLabel");

// ‚îÄ‚îÄ –£—Ç–∏–ª–∏—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatTime(ts) {
    if (!ts) return "";
    const d = new Date(ts), now = new Date();
    const pad = n => String(n).padStart(2, "0");
    const time = pad(d.getHours()) + ":" + pad(d.getMinutes());
    if (d.toDateString() === now.toDateString()) return time;
    return pad(d.getDate()) + "." + pad(d.getMonth() + 1) + " " + time;
}

function formatLastSeen(ts) {
    if (!ts) return "";
    const diff = Date.now() - ts;
    const mins = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    if (mins < 1) return "–±—ã–ª(–∞) —Ç–æ–ª—å–∫–æ —á—Ç–æ";
    if (mins < 60) return "–±—ã–ª(–∞) " + mins + " –º–∏–Ω. –Ω–∞–∑–∞–¥";
    if (hours < 24) return "–±—ã–ª(–∞) " + hours + " —á. –Ω–∞–∑–∞–¥";
    return "–±—ã–ª(–∞) " + days + " –¥–Ω. –Ω–∞–∑–∞–¥";
}

function updateLastSeenLabel() {
    if (!active || active.startsWith("g_")) { lastSeenLabel.textContent = ""; return; }
    if (state.online[active]) { lastSeenLabel.textContent = ""; return; }
    const ts = state.lastSeen[active];
    lastSeenLabel.textContent = ts ? formatLastSeen(ts) : "";
}

function b64toBlob(b64, type) {
    const bytes = atob(b64), arr = new Uint8Array(bytes.length);
    for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
    return new Blob([arr], { type });
}

// ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMessageEl(m, showSender) {
    const isMine = m.from === myName;
    const wrap = document.createElement("div");
    wrap.className = "message " + (isMine ? "me" : "them");
    if (m.id) wrap.dataset.id = m.id;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ –¥–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if (showSender && !isMine && m.from) {
        const senderEl = document.createElement("div");
        senderEl.className = "msg-sender";
        senderEl.textContent = m.from;
        wrap.appendChild(senderEl);
    }

    if (m.replyTo) {
        const quote = document.createElement("div");
        quote.className = "msg-reply-quote";
        const author = document.createElement("div");
        author.className = "msg-reply-author";
        author.textContent = m.replyTo.from;
        const preview = document.createElement("div");
        preview.className = "msg-reply-text";
        preview.textContent = m.replyTo.text || (m.replyTo.mediaType ? "üìé –í–ª–æ–∂–µ–Ω–∏–µ" : "");
        quote.append(author, preview);
        quote.onclick = (e) => {
            e.stopPropagation();
            const target = messagesEl.querySelector(`[data-id="${m.replyTo.id}"]`);
            if (target) {
                target.scrollIntoView({ behavior: "smooth", block: "center" });
                target.style.transition = "background .3s";
                target.style.background = "var(--me-bg)";
                setTimeout(() => target.style.background = "", 1200);
            }
        };
        wrap.appendChild(quote);
    }

    if (m.forwardedFrom) {
        const fwd = document.createElement("div");
        fwd.className = "msg-forward-label";
        fwd.textContent = "–ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç " + m.forwardedFrom;
        wrap.appendChild(fwd);
    }

    if (m.deleted) {
        const txt = document.createElement("span");
        txt.className = "msg-text msg-deleted";
        txt.textContent = "–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ";
        wrap.appendChild(txt);
    } else if (m.mediaType && m.mediaData) {
        const media = document.createElement("div");
        media.className = "msg-media";
        if (m.mediaType.startsWith("image/")) {
            const img = document.createElement("img");
            img.src = "data:" + m.mediaType + ";base64," + m.mediaData;
            img.alt = m.fileName || "image";
            media.appendChild(img);
        } else if (m.mediaType.startsWith("video/")) {
            const vid = document.createElement("video");
            vid.src = "data:" + m.mediaType + ";base64," + m.mediaData;
            vid.controls = true;
            media.appendChild(vid);
        } else if (m.mediaType.startsWith("audio/")) {
            const aud = document.createElement("audio");
            aud.src = "data:" + m.mediaType + ";base64," + m.mediaData;
            aud.controls = true;
            media.appendChild(aud);
        } else {
            const a = document.createElement("a");
            const blob = b64toBlob(m.mediaData, m.mediaType);
            a.href = URL.createObjectURL(blob);
            a.download = m.fileName || "file";
            a.textContent = "üìÑ " + (m.fileName || "file");
            a.style.cssText = "color:var(--accent);font-size:13px";
            media.appendChild(a);
        }
        wrap.appendChild(media);
    } else {
        const txt = document.createElement("span");
        txt.className = "msg-text";
        txt.textContent = m.text || "";
        wrap.appendChild(txt);
    }

    // –Ω–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞: –≤—Ä–µ–º—è + –ø–æ–º–µ—Ç–∫–∞ "–∏–∑–º–µ–Ω–µ–Ω–æ" + –≥–∞–ª–æ—á–∫–∏
    const meta = document.createElement("span");
    meta.className = "msg-time";
    meta.textContent = formatTime(m.ts) + (m.edited && !m.deleted ? " ¬∑ –∏–∑–º." : "");

    if (isMine && m.id && !m.deleted) {
        const ticks = document.createElement("span");
        ticks.className = "msg-ticks";
        ticks.dataset.ticksFor = m.id;
        if (showSender) {
            // –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            const readers = (state.groupReadBy[m.id] || []);
            ticks.textContent = readers.length > 0 ? "‚úì‚úì" : "‚úì";
            if (readers.length > 0) ticks.classList.add("read");
        } else {
            // –õ–° ‚Äî —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º lastReadId —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
            const convKey = m.to === myName ? m.from : m.to;
            const lastRead = state.readStatus[convKey];
            const conv = state.conversations[convKey] || [];
            const msgIdx = conv.findIndex(x => x.id === m.id);
            const lastReadIdx = lastRead ? conv.findIndex(x => x.id === lastRead) : -1;
            const isRead = lastRead && lastReadIdx >= msgIdx && msgIdx !== -1;
            ticks.textContent = isRead ? "‚úì‚úì" : "‚úì";
            if (isRead) ticks.classList.add("read");
        }
        meta.appendChild(ticks);
    }
    wrap.appendChild(meta);

    // –î–ª—è –≥—Ä—É–ø–ø: —Å–ø–∏—Å–æ–∫ –Ω–∏–∫–æ–≤ –∫—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª (–ø–æ–¥ —Å–≤–æ–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏)
    if (isMine && showSender && m.id && !m.deleted) {
        const readers = state.groupReadBy[m.id] || [];
        if (readers.length > 0) {
            const rb = document.createElement("div");
            rb.className = "msg-read-by";
            rb.dataset.readBy = m.id;
            rb.textContent = "–ü—Ä–æ—á–∏—Ç–∞–ª–∏: " + readers.join(", ");
            wrap.appendChild(rb);
        }
    }

    // –†–µ–∞–∫—Ü–∏–∏
    if (m.id) {
        const reacts = state.reactions[m.id];
        if (reacts && Object.keys(reacts).length > 0) {
            const row = document.createElement("div");
            row.className = "msg-reactions";
            row.dataset.reactionsFor = m.id;
            renderReactionChips(row, m.id);
            wrap.appendChild(row);
        }
    }

    // –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –ª—é–±–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (–Ω–µ —É–¥–∞–ª—ë–Ω–Ω–æ–º)
    if (!m.deleted && m.id) {
        const openMenu = (e) => {
            e.preventDefault();
            showMsgCtxMenu(e.clientX || e.touches?.[0]?.clientX || 0,
                           e.clientY || e.touches?.[0]?.clientY || 0, m);
        };
        wrap.addEventListener("contextmenu", openMenu);
        let longPress;
        wrap.addEventListener("touchstart", () => { longPress = setTimeout(() => openMenu({ preventDefault(){}, clientX:0, clientY: wrap.getBoundingClientRect().top + 40 }), 600); }, { passive: true });
        wrap.addEventListener("touchend", () => clearTimeout(longPress));
        wrap.addEventListener("touchmove", () => clearTimeout(longPress));
    }

    return wrap;
}

// ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderContacts() {
    contactsEl.innerHTML = "";

    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∞–π—Ç–µ–º—ã: –ª–∏—á–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã + –≥—Ä—É–ø–ø—ã
    const items = [];
    state.contacts.forEach(name => items.push({ key: name, isGroup: false }));
    Object.keys(state.groups).forEach(gid => items.push({ key: gid, isGroup: true }));
    items.sort((a, b) => (state.lastMsg[b.key] || 0) - (state.lastMsg[a.key] || 0));

    items.forEach(({ key, isGroup }) => {
        const d = document.createElement("div");
        d.className = "contact" + (key === active ? " active-contact" : "");

        const left = document.createElement("div");
        left.className = "contact-left";
        const nameEl = document.createElement("div");
        nameEl.className = "contact-name";
        if (isGroup) {
            const icon = document.createElement("span");
            icon.className = "contact-group-icon";
            icon.textContent = "üë• ";
            nameEl.appendChild(icon);
            nameEl.appendChild(document.createTextNode(state.groups[key].name));
        } else {
            nameEl.textContent = key;
        }
        const typingEl = document.createElement("div");
        typingEl.className = "contact-typing";
        typingEl.textContent = typingTimers[key] ? "–ø–µ—á–∞—Ç–∞–µ—Ç..." : "";
        left.append(nameEl, typingEl);

        const right = document.createElement("div");
        right.className = "contact-right";
        if (!isGroup) {
            const statusEl = document.createElement("span");
            statusEl.className = state.online[key] ? "status-online" : "status-offline";
            statusEl.textContent = state.online[key] ? "‚óè online" : "‚óè offline";
            right.appendChild(statusEl);
        }
        const unread = state.unread[key] || 0;
        if (unread > 0) {
            const badge = document.createElement("div");
            badge.className = "unread-badge";
            badge.textContent = unread > 99 ? "99+" : unread;
            right.appendChild(badge);
        }

        d.append(left, right);
        d.onclick = () => isGroup ? openGroupChat(key) : openChat(key);
        d.oncontextmenu = e => { e.preventDefault(); showCtxMenu(e.clientX, e.clientY, key, isGroup); };
        contactsEl.appendChild(d);
    });
}

function sendReadReceipt(convKey) {
    const conv = state.conversations[convKey] || [];
    let lastId = null;
    for (let i = conv.length - 1; i >= 0; i--) {
        if (conv[i].from !== myName && conv[i].id) { lastId = conv[i].id; break; }
    }
    if (lastId && socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ type: "read", from: myName, to: convKey, lastId }));
    }
}

function sendGroupReadReceipt(gid) {
    const conv = state.conversations[gid] || [];
    let lastId = null;
    for (let i = conv.length - 1; i >= 0; i--) {
        if (conv[i].from !== myName && conv[i].id) { lastId = conv[i].id; break; }
    }
    if (lastId && socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ type: "groupRead", from: myName, groupId: gid, lastId }));
    }
}

function openChat(name) {
    active = name;
    state.unread[name] = 0;
    save();
    chatHeader.firstChild.textContent = "–ß–∞—Ç —Å " + name;
    typingIndicator.textContent = "";
    document.getElementById("callBtn").style.display = "";
    document.getElementById("addMemberBtn").style.display = "none";
    renderContacts();
    renderMessages();
    updateLastSeenLabel();
    sendReadReceipt(name);
    appEl.classList.add("chat-open");
}

function openGroupChat(gid) {
    active = gid;
    state.unread[gid] = 0;
    save();
    const g = state.groups[gid];
    chatHeader.firstChild.textContent = g ? g.name : gid;
    typingIndicator.textContent = "";
    lastSeenLabel.textContent = "";
    document.getElementById("callBtn").style.display = "none";
    document.getElementById("addMemberBtn").style.display = "";
    renderContacts();
    renderMessages();
    sendGroupReadReceipt(gid);
    appEl.classList.add("chat-open");
}

// ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isGroupActive() { return active && active.startsWith("g_"); }

function renderMessages() {
    messagesEl.innerHTML = "";
    if (!active) return;
    const showSender = isGroupActive();
    (state.conversations[active] || []).forEach(m => messagesEl.appendChild(renderMessageEl(m, showSender)));
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

function appendMessage(m) {
    const peer = m.from === myName ? m.to : m.from;
    if (active === peer) {
        messagesEl.appendChild(renderMessageEl(m, isGroupActive()));
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
}

function appendGroupMessage(m) {
    if (active === m.groupId) {
        messagesEl.appendChild(renderMessageEl(m, true));
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
}

function genId() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

function sendMsg(msg) {
    if (!msg.id) msg.id = genId();
    if (!state.conversations[msg.to]) state.conversations[msg.to] = [];
    state.conversations[msg.to].push(msg);
    state.lastMsg[msg.to] = msg.ts || Date.now();
    socket.send(JSON.stringify(msg));
    save();
    appendMessage(msg);
    renderContacts();
}

function sendGroupMsg(msg) {
    if (!msg.id) msg.id = genId();
    const gid = msg.groupId;
    if (!state.conversations[gid]) state.conversations[gid] = [];
    state.conversations[gid].push(msg);
    state.lastMsg[gid] = msg.ts || Date.now();
    socket.send(JSON.stringify(msg));
    save();
    appendGroupMessage(msg);
    renderContacts();
}

// –ù–∞–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ id –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ —Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º
function findMsg(convKey, id) {
    const conv = state.conversations[convKey];
    if (!conv) return null;
    const idx = conv.findIndex(m => m.id === id);
    return idx === -1 ? null : { conv, idx };
}

// ‚îÄ‚îÄ –†–µ–∞–∫—Ü–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é: emoji=null —Å–Ω–∏–º–∞–µ—Ç, –∏–Ω–∞—á–µ —Å—Ç–∞–≤–∏—Ç (toggle –µ—Å–ª–∏ —Å–≤–æ—è)
function applyReaction(msgId, emoji, fromNick) {
    if (!state.reactions[msgId]) state.reactions[msgId] = {};
    const r = state.reactions[msgId];
    if (emoji === null) {
        // –°–Ω—è—Ç—å –ª—é–±—É—é —Ä–µ–∞–∫—Ü–∏—é —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        for (const e in r) {
            r[e] = r[e].filter(n => n !== fromNick);
            if (r[e].length === 0) delete r[e];
        }
    } else {
        // –£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ä–µ–∞–∫—Ü–∏—é —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–¥–∏–Ω emoji –∑–∞ —Ä–∞–∑)
        for (const e in r) {
            r[e] = r[e].filter(n => n !== fromNick);
            if (r[e].length === 0) delete r[e];
        }
        if (!r[emoji]) r[emoji] = [];
        r[emoji].push(fromNick);
    }
}

function renderReactionChips(container, msgId) {
    container.innerHTML = "";
    const reacts = state.reactions[msgId] || {};
    for (const [emoji, nicks] of Object.entries(reacts)) {
        if (!nicks.length) continue;
        const chip = document.createElement("div");
        chip.className = "reaction-chip" + (nicks.includes(myName) ? " mine" : "");
        chip.title = nicks.join(", ");
        chip.innerHTML = emoji + ' <span class="rc-count">' + nicks.length + '</span>';
        chip.onclick = () => toggleReaction(msgId, emoji);
        container.appendChild(chip);
    }
}

function updateReactionsInDOM(msgId) {
    const wrap = messagesEl.querySelector(`[data-id="${msgId}"]`);
    if (!wrap) return;
    let row = wrap.querySelector(`[data-reactions-for="${msgId}"]`);
    const reacts = state.reactions[msgId] || {};
    const hasReacts = Object.values(reacts).some(a => a.length > 0);
    if (!hasReacts) { if (row) row.remove(); return; }
    if (!row) {
        row = document.createElement("div");
        row.className = "msg-reactions";
        row.dataset.reactionsFor = msgId;
        // –≤—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º —Ç–µ–≥–æ–º ‚Äî –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–æ—á–µ—Ä–Ω–µ–≥–æ
        wrap.appendChild(row);
    }
    renderReactionChips(row, msgId);
}

function toggleReaction(msgId, emoji) {
    // –ù–∞–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –∫—É–¥–∞ —Å–ª–∞—Ç—å
    const msg = findMsgById(msgId);
    if (!msg) return;
    const reacts = state.reactions[msgId] || {};
    const alreadyMine = (reacts[emoji] || []).includes(myName);
    const newEmoji = alreadyMine ? null : emoji;
    applyReaction(msgId, newEmoji, myName);
    save();
    updateReactionsInDOM(msgId);
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    if (msg.groupId) {
        socket.send(JSON.stringify({ type: "groupReaction", from: myName, groupId: msg.groupId, msgId, emoji: newEmoji }));
    } else {
        const peer = msg.from === myName ? msg.to : msg.from;
        socket.send(JSON.stringify({ type: "reaction", from: myName, to: peer, msgId, emoji: newEmoji }));
    }
}

function findMsgById(msgId) {
    // –ò—â–µ–º –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ —Å–Ω–∞—á–∞–ª–∞, –ø–æ—Ç–æ–º –≤–æ –≤—Å–µ—Ö
    const checkConv = (key) => {
        const conv = state.conversations[key] || [];
        const m = conv.find(x => x.id === msgId);
        return m || null;
    };
    if (active) {
        const m = checkConv(active);
        if (m) return m;
    }
    for (const key of Object.keys(state.conversations)) {
        const m = checkConv(key);
        if (m) return m;
    }
    return null;
}

// ‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mainMessageHandler(e) {
    let data;
    try { data = JSON.parse(e.data); } catch { return; }

    if (data.type === "kicked") {
        localStorage.removeItem("session");
        alert("–í—ã –≤–æ—à–ª–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.");
        location.reload();
        return;
    }

    if (data.type === "onlineList") {
        state.online = data.users;
        if (data.lastSeen) Object.assign(state.lastSeen, data.lastSeen);
        save(); renderContacts();
        updateLastSeenLabel();
        return;
    }

    if (data.type === "nickResult") {
        const cbs = nickCallbacks[data.nick];
        if (cbs) {
            delete nickCallbacks[data.nick];
            cbs.forEach(fn => fn(data.exists));
        }
        return;
    }

    if (data.type === "typing") {
        const from = data.from;
        if (typingTimers[from]) clearTimeout(typingTimers[from]);
        typingTimers[from] = setTimeout(() => {
            delete typingTimers[from];
            renderContacts();
            if (active === from) typingIndicator.textContent = "";
        }, 3000);
        renderContacts();
        if (active === from) typingIndicator.textContent = " –ø–µ—á–∞—Ç–∞–µ—Ç...";
        return;
    }

    if (data.type === "message") {
        const from = data.from;
        if (typingTimers[from]) { clearTimeout(typingTimers[from]); delete typingTimers[from]; }
        if (active === from) typingIndicator.textContent = "";
        if (!state.conversations[from]) state.conversations[from] = [];
        state.conversations[from].push(data);
        if (!state.contacts.includes(from)) state.contacts.push(from);
        state.lastMsg[from] = data.ts || Date.now();
        if (active !== from) state.unread[from] = (state.unread[from] || 0) + 1;
        msgSound.play().catch(() => {});
        const notifBody = data.text ? data.text.slice(0, 100) : 'üìé –í–ª–æ–∂–µ–Ω–∏–µ';
        showNotification(from, notifBody, from);
        save(); renderContacts();
        appendMessage(data);
        if (active === from) sendReadReceipt(from);
        return;
    }

    if (data.type === "deliveryError") {
        if (data.error === "no_user") {
            showSystemMsg("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´" + data.to + "¬ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.");
            // –æ—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏
            const conv = state.conversations[data.to];
            if (conv && conv.length) {
                const last = conv[conv.length - 1];
                if (last.from === myName) conv.pop();
            }
            save(); renderMessages();
        }
        return;
    }

    if (data.type === "edit") {
        // —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∏–∑–º–µ–Ω–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ
        const found = findMsg(data.from, data.id);
        if (found) {
            found.conv[found.idx].text = data.text;
            found.conv[found.idx].edited = true;
            save();
            if (active === data.from) {
                const el = messagesEl.querySelector(`[data-id="${data.id}"]`);
                if (el) el.replaceWith(renderMessageEl(found.conv[found.idx]));
            }
        }
        return;
    }

    if (data.type === "delete") {
        // —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É–¥–∞–ª–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ
        const found = findMsg(data.from, data.id);
        if (found) {
            found.conv[found.idx].deleted = true;
            found.conv[found.idx].text = "";
            delete found.conv[found.idx].mediaData;
            delete found.conv[found.idx].mediaType;
            save();
            if (active === data.from) {
                const el = messagesEl.querySelector(`[data-id="${data.id}"]`);
                if (el) el.replaceWith(renderMessageEl(found.conv[found.idx]));
            }
        }
        return;
    }

    if (data.type === "signal") { handleSignal(data); return; }

    // ‚îÄ‚îÄ –ì—Ä—É–ø–ø–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    if (data.type === "groupList") {
        // –ü–æ–ª—É—á–∏–ª–∏ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
        Object.assign(state.groups, data.groups);
        save(); renderContacts();
        return;
    }

    if (data.type === "groupCreated") {
        state.groups[data.group.id] = data.group;
        save(); renderContacts();
        return;
    }

    if (data.type === "groupMemberAdded") {
        state.groups[data.groupId] = data.group;
        save();
        if (active === data.groupId) chatHeader.firstChild.textContent = data.group.name;
        renderContacts();
        if (typeof _origGroupMemberAdded === "function") _origGroupMemberAdded(data.groupId);
        return;
    }

    if (data.type === "addMemberError") {
        const errEl = document.getElementById("addMemberError");
        if (data.error === "no_user") errEl.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
        else if (data.error === "already_member") errEl.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –≥—Ä—É–ø–ø–µ";
        document.getElementById("addMemberConfirmBtn").disabled = false;
        return;
    }

    if (data.type === "groupMessage") {
        const gid = data.groupId;
        if (!state.groups[gid]) return;
        if (typingTimers[gid]) { clearTimeout(typingTimers[gid]); delete typingTimers[gid]; }
        if (!state.conversations[gid]) state.conversations[gid] = [];
        state.conversations[gid].push(data);
        state.lastMsg[gid] = data.ts || Date.now();
        if (active !== gid) state.unread[gid] = (state.unread[gid] || 0) + 1;
        msgSound.play().catch(() => {});
        const grpName = state.groups[gid] ? state.groups[gid].name : gid;
        const grpBody = data.from + ': ' + (data.text ? data.text.slice(0, 100) : 'üìé –í–ª–æ–∂–µ–Ω–∏–µ');
        showNotification(grpName, grpBody, gid);
        save(); renderContacts();
        appendGroupMessage(data);
        if (active === gid) sendGroupReadReceipt(gid);
        return;
    }

    if (data.type === "groupEdit") {
        const found = findMsg(data.groupId, data.id);
        if (found) {
            found.conv[found.idx].text = data.text;
            found.conv[found.idx].edited = true;
            save();
            if (active === data.groupId) {
                const el = messagesEl.querySelector(`[data-id="${data.id}"]`);
                if (el) el.replaceWith(renderMessageEl(found.conv[found.idx], true));
            }
        }
        return;
    }

    if (data.type === "groupDelete") {
        const found = findMsg(data.groupId, data.id);
        if (found) {
            found.conv[found.idx].deleted = true;
            found.conv[found.idx].text = "";
            delete found.conv[found.idx].mediaData;
            delete found.conv[found.idx].mediaType;
            save();
            if (active === data.groupId) {
                const el = messagesEl.querySelector(`[data-id="${data.id}"]`);
                if (el) el.replaceWith(renderMessageEl(found.conv[found.idx], true));
            }
        }
        return;
    }

    if (data.type === "groupTyping") {
        const gid = data.groupId;
        if (typingTimers[gid]) clearTimeout(typingTimers[gid]);
        typingTimers[gid] = setTimeout(() => {
            delete typingTimers[gid];
            renderContacts();
            if (active === gid) typingIndicator.textContent = "";
        }, 3000);
        renderContacts();
        if (active === gid) typingIndicator.textContent = " " + data.from + " –ø–µ—á–∞—Ç–∞–µ—Ç...";
        return;
    }

    // ‚îÄ‚îÄ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ (–õ–°) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (data.type === "read") {
        // –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø—Ä–æ—á–∏—Ç–∞–ª –Ω–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ data.lastId
        state.readStatus[data.from] = data.lastId;
        save();
        if (active === data.from) {
            // –û–±–Ω–æ–≤–∏—Ç—å –≥–∞–ª–æ—á–∫–∏ —É –≤—Å–µ—Ö —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ DOM
            const conv = state.conversations[data.from] || [];
            const lastReadIdx = conv.findIndex(m => m.id === data.lastId);
            conv.forEach((m, idx) => {
                if (m.from !== myName || !m.id) return;
                const tickEl = messagesEl.querySelector(`[data-ticks-for="${m.id}"]`);
                if (!tickEl) return;
                const isRead = lastReadIdx !== -1 && idx <= lastReadIdx;
                tickEl.textContent = isRead ? "‚úì‚úì" : "‚úì";
                tickEl.classList.toggle("read", isRead);
            });
        }
        return;
    }

    // ‚îÄ‚îÄ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ (–≥—Ä—É–ø–ø–∞) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (data.type === "groupRead") {
        // –£—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–æ—á–∏—Ç–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã –¥–æ data.lastId
        const gid = data.groupId;
        const conv = state.conversations[gid] || [];
        const lastReadIdx = conv.findIndex(m => m.id === data.lastId);
        // –û—Ç–º–µ—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ lastId –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —ç—Ç–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º
        for (let i = 0; i <= lastReadIdx && i < conv.length; i++) {
            const m = conv[i];
            if (m.from !== myName || !m.id) continue;
            if (!state.groupReadBy[m.id]) state.groupReadBy[m.id] = [];
            if (!state.groupReadBy[m.id].includes(data.from)) {
                state.groupReadBy[m.id].push(data.from);
            }
        }
        save();
        if (active === gid) {
            // –û–±–Ω–æ–≤–∏—Ç—å –≥–∞–ª–æ—á–∫–∏ –∏ —Å—Ç—Ä–æ–∫–∏ "–ø—Ä–æ—á–∏—Ç–∞–ª–∏" –≤ DOM
            conv.forEach(m => {
                if (m.from !== myName || !m.id) return;
                const readers = state.groupReadBy[m.id] || [];
                const tickEl = messagesEl.querySelector(`[data-ticks-for="${m.id}"]`);
                if (tickEl) {
                    tickEl.textContent = readers.length > 0 ? "‚úì‚úì" : "‚úì";
                    tickEl.classList.toggle("read", readers.length > 0);
                }
                const rbEl = messagesEl.querySelector(`[data-read-by="${m.id}"]`);
                if (readers.length > 0) {
                    if (rbEl) {
                        rbEl.textContent = "–ü—Ä–æ—á–∏—Ç–∞–ª–∏: " + readers.join(", ");
                    } else {
                        // –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç
                        const wrap = messagesEl.querySelector(`[data-id="${m.id}"]`);
                        if (wrap) {
                            const rb = document.createElement("div");
                            rb.className = "msg-read-by";
                            rb.dataset.readBy = m.id;
                            rb.textContent = "–ü—Ä–æ—á–∏—Ç–∞–ª–∏: " + readers.join(", ");
                            wrap.appendChild(rb);
                        }
                    }
                }
            });
        }
        return;
    }

    // ‚îÄ‚îÄ –†–µ–∞–∫—Ü–∏—è (–õ–° –∏–ª–∏ –≥—Ä—É–ø–ø–∞) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (data.type === "reaction" || data.type === "groupReaction") {
        applyReaction(data.msgId, data.emoji, data.from);
        save();
        updateReactionsInDOM(data.msgId);
        return;
    }
}

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectAndAuth(nick, password) {
    authError.textContent = "";
    if (!nick || !password) { authError.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"; return; }
    authSubmit.disabled = true;

    const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host;
    socket = new WebSocket(wsUrl);

    socket.onopen = () => socket.send(JSON.stringify({ type: authMode, nick, password }));

    socket.onmessage = e => {
        let data;
        try { data = JSON.parse(e.data); } catch { return; }
        if (data.type !== "authResult") return;
        if (data.success) {
            myName = data.nick;
            // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
            localStorage.setItem("session", JSON.stringify({ nick, password }));
            document.getElementById("myNickLabel").textContent = "–í—ã: " + myName;
            authOverlay.style.display = "none";
            appDiv.style.display = "grid";
            socket.onmessage = mainMessageHandler;
            renderContacts();
            setupNotifications();
        } else {
            authError.textContent = data.error || "–û—à–∏–±–∫–∞";
            authSubmit.disabled = false;
            socket.close();
            // –µ—Å–ª–∏ –∞–≤—Ç–æ–≤—Ö–æ–¥ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è ‚Äî —É–±–∏—Ä–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            localStorage.removeItem("session");
        }
    };

    socket.onerror = () => {
        authError.textContent = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
        authSubmit.disabled = false;
    };
}

authSubmit.onclick = () => connectAndAuth(
    document.getElementById("authNick").value.trim(),
    document.getElementById("authPassword").value
);
["authNick","authPassword"].forEach(id =>
    document.getElementById(id).addEventListener("keydown", e => {
        if (e.key === "Enter") authSubmit.click();
    })
);

authToggle.onclick = () => {
    if (authMode === "login") {
        authMode = "register";
        authTitle.textContent = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
        authSubmit.textContent = "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è";
        authSwitch.innerHTML = '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a id="authToggle">–í–æ–π—Ç–∏</a>';
    } else {
        authMode = "login";
        authTitle.textContent = "–í—Ö–æ–¥";
        authSubmit.textContent = "–í–æ–π—Ç–∏";
        authSwitch.innerHTML = '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a id="authToggle">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>';
    }
    authError.textContent = "";
    document.getElementById("authToggle").onclick = authToggle.onclick;
};

// –∞–≤—Ç–æ–≤—Ö–æ–¥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
if (savedSession) {
    connectAndAuth(savedSession.nick, savedSession.password);
}

// ‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ (keydown ‚Äî Enter) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("messageInput").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendBtn.click(); return; }
    if (!active || !socket) return;
    if (!myTypingActive) {
        myTypingActive = true;
        if (isGroupActive()) {
            socket.send(JSON.stringify({ type: "groupTyping", from: myName, groupId: active }));
        } else {
            socket.send(JSON.stringify({ type: "typing", from: myName, to: active }));
        }
    }
    clearTimeout(myTypingTimer);
    myTypingTimer = setTimeout(() => { myTypingActive = false; }, 2500);
});
// –°–±—Ä–æ—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
document.getElementById("messageInput").addEventListener("keydown", e => {
    if (e.key === "Escape") {
        if (editingMsg) document.getElementById("editCancelBtn").click();
        else if (replyingTo) closeReplyBar();
    }
});

// ‚îÄ‚îÄ –§–∞–π–ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("attachBtn").onclick = () => { if (active) fileInput.click(); };
fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return;
    fileInput.value = "";
    if (file.size > 10 * 1024 * 1024) { alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10 –ú–ë)"); return; }
    const reader = new FileReader();
    reader.onload = ev => {
        const replyTo = replyingTo ? { ...replyingTo } : undefined;
        if (isGroupActive()) {
            sendGroupMsg({ type: "groupMessage", from: myName, groupId: active, text: "",
                mediaType: file.type, mediaData: ev.target.result.split(",")[1],
                fileName: file.name, ts: Date.now(), replyTo });
        } else {
            sendMsg({ type: "message", from: myName, to: active, text: "",
                mediaType: file.type, mediaData: ev.target.result.split(",")[1],
                fileName: file.name, ts: Date.now(), replyTo });
        }
        closeReplyBar();
    };
    reader.readAsDataURL(file);
};

// ‚îÄ‚îÄ –ì–æ–ª–æ—Å–æ–≤–æ–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
voiceBtn.onclick = async () => {
    if (!active) return;
    if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.stop(); return; }
    let stream;
    try { stream = await navigator.mediaDevices.getUserMedia({ audio: true }); }
    catch { alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"); return; }
    voiceChunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => voiceChunks.push(e.data);
    mediaRecorder.onstop = () => {
        stream.getTracks().forEach(t => t.stop());
        voiceBtn.classList.remove("recording");
        const blob = new Blob(voiceChunks, { type: mediaRecorder.mimeType || "audio/webm" });
        const reader = new FileReader();
        reader.onload = ev => {
            const activeAtRecord = active;
            const replyTo = replyingTo ? { ...replyingTo } : undefined;
            if (activeAtRecord && activeAtRecord.startsWith("g_")) {
                sendGroupMsg({ type: "groupMessage", from: myName, groupId: activeAtRecord, text: "",
                    mediaType: blob.type, mediaData: ev.target.result.split(",")[1],
                    fileName: "voice.webm", ts: Date.now(), replyTo });
            } else {
                sendMsg({ type: "message", from: myName, to: activeAtRecord, text: "",
                    mediaType: blob.type, mediaData: ev.target.result.split(",")[1],
                    fileName: "voice.webm", ts: Date.now(), replyTo });
            }
            closeReplyBar();
        };
        reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    voiceBtn.classList.add("recording");
};

// ‚îÄ‚îÄ –í—ã–π—Ç–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("logoutBtn").onclick = () => {
    localStorage.removeItem("session");
    if (socket) socket.close();
    location.reload();
};

// ‚îÄ‚îÄ –ù–∞–∑–∞–¥ (–º–æ–±–∏–ª—å–Ω—ã–π) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("backBtn").onclick = () => {
    appEl.classList.remove("chat-open");
    active = null;
};

// ‚îÄ‚îÄ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ctxMenu = document.getElementById("ctxMenu");
let ctxTarget = null;
let ctxIsGroup = false;
function showCtxMenu(x, y, name, isGroup) {
    ctxTarget = name;
    ctxIsGroup = !!isGroup;
    const mw = 170, mh = 80;
    ctxMenu.style.left = Math.min(x, window.innerWidth - mw - 8) + "px";
    ctxMenu.style.top  = Math.min(y, window.innerHeight - mh - 8) + "px";
    ctxMenu.style.display = "block";
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –ø—É–Ω–∫—Ç—ã
    document.getElementById("ctxDelete").style.display = isGroup ? "none" : "";
    document.getElementById("ctxLeaveGroup").style.display = isGroup ? "" : "none";
}
function hideCtxMenu() { ctxMenu.style.display = "none"; ctxTarget = null; }
document.addEventListener("click", hideCtxMenu);
document.addEventListener("keydown", e => { if (e.key === "Escape") hideCtxMenu(); });

document.getElementById("ctxClear").onclick = () => {
    if (!ctxTarget) return;
    state.conversations[ctxTarget] = [];
    save();
    if (active === ctxTarget) renderMessages();
    hideCtxMenu();
};
document.getElementById("ctxDelete").onclick = () => {
    if (!ctxTarget) return;
    state.contacts = state.contacts.filter(c => c !== ctxTarget);
    delete state.conversations[ctxTarget];
    delete state.unread[ctxTarget];
    delete state.lastMsg[ctxTarget];
    if (active === ctxTarget) {
        active = null;
        chatHeader.firstChild.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç";
        typingIndicator.textContent = "";
        renderMessages();
        appEl.classList.remove("chat-open");
    }
    save(); renderContacts();
    hideCtxMenu();
};
document.getElementById("ctxLeaveGroup").onclick = () => {
    if (!ctxTarget) return;
    delete state.groups[ctxTarget];
    delete state.conversations[ctxTarget];
    delete state.unread[ctxTarget];
    delete state.lastMsg[ctxTarget];
    if (active === ctxTarget) {
        active = null;
        chatHeader.firstChild.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç";
        typingIndicator.textContent = "";
        document.getElementById("callBtn").style.display = "";
        renderMessages();
        appEl.classList.remove("chat-open");
    }
    save(); renderContacts();
    hideCtxMenu();
};

// ‚îÄ‚îÄ –ú–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const msgCtxMenu = document.getElementById("msgCtxMenu");
let msgCtxTarget = null; // –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

function showMsgCtxMenu(x, y, msg) {
    msgCtxTarget = msg;
    const isMine = msg.from === myName;
    document.getElementById("msgCtxEdit").style.display = isMine ? "" : "none";
    document.getElementById("msgCtxDelete").style.display = isMine ? "" : "none";
    const mw = 230, mh = 120;
    msgCtxMenu.style.left = Math.min(x, window.innerWidth - mw - 8) + "px";
    msgCtxMenu.style.top  = Math.min(y, window.innerHeight - mh - 8) + "px";
    msgCtxMenu.style.display = "block";
}
function hideMsgCtxMenu() { msgCtxMenu.style.display = "none"; msgCtxTarget = null; }
document.addEventListener("click", hideMsgCtxMenu);

// –ö–ª–∏–∫ –ø–æ —ç–º–æ–¥–∑–∏ –≤ –ø–∏–∫–µ—Ä–µ
document.getElementById("reactionPicker").addEventListener("click", e => {
    const btn = e.target.closest("button[data-emoji]");
    if (!btn || !msgCtxTarget) return;
    e.stopPropagation();
    toggleReaction(msgCtxTarget.id, btn.dataset.emoji);
    hideMsgCtxMenu();
});

const editBar     = document.getElementById("editBar");
const editBarText = document.getElementById("editBarText");
const replyBar    = document.getElementById("replyBar");
const msgInput    = document.getElementById("messageInput");
const sendBtn     = document.getElementById("sendBtn");

function openReplyBar(msg) {
    replyingTo = { id: msg.id, from: msg.from, text: msg.text || "", mediaType: msg.mediaType };
    document.getElementById("replyBarAuthor").textContent = msg.from;
    document.getElementById("replyBarText").textContent = msg.text || (msg.mediaType ? "üìé –í–ª–æ–∂–µ–Ω–∏–µ" : "");
    replyBar.style.display = "flex";
    // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç editBar ‚Äî –∑–∞–∫—Ä—ã—Ç—å –µ–≥–æ
    editingMsg = null;
    editBar.style.display = "none";
    msgInput.value = "";
    msgInput.focus();
}
function closeReplyBar() {
    replyingTo = null;
    replyBar.style.display = "none";
}
document.getElementById("replyCancelBtn").onclick = closeReplyBar;

document.getElementById("msgCtxReply").onclick = () => {
    if (!msgCtxTarget) return;
    const msg = msgCtxTarget;
    hideMsgCtxMenu();
    openReplyBar(msg);
};

document.getElementById("msgCtxEdit").onclick = () => {
    if (!msgCtxTarget) return;
    const msg = msgCtxTarget;
    hideMsgCtxMenu();
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º edit-bar
    editingMsg = msg;
    editBarText.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: " + (msg.text || "(–º–µ–¥–∏–∞)");
    editBar.style.display = "flex";
    msgInput.value = msg.text || "";
    msgInput.focus();
};

document.getElementById("msgCtxDelete").onclick = () => {
    if (!msgCtxTarget) return;
    const msg = msgCtxTarget;
    hideMsgCtxMenu();
    const convKey = msg.to === myName ? msg.from : msg.to;
    const found = findMsg(convKey, msg.id);
    if (!found) return;
    // –ª–æ–∫–∞–ª—å–Ω–æ
    found.conv[found.idx].deleted = true;
    found.conv[found.idx].text = "";
    delete found.conv[found.idx].mediaData;
    delete found.conv[found.idx].mediaType;
    save();
    // –≤ DOM
    const isGrpMsg = !!msg.groupId;
    const el = messagesEl.querySelector(`[data-id="${msg.id}"]`);
    if (el) el.replaceWith(renderMessageEl(found.conv[found.idx], isGrpMsg));
    // –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
    if (isGrpMsg) {
        socket.send(JSON.stringify({ type: "groupDelete", from: myName, groupId: msg.groupId, id: msg.id }));
    } else {
        const to = msg.to === myName ? msg.from : msg.to;
        socket.send(JSON.stringify({ type: "delete", from: myName, to, id: msg.id }));
    }
};

document.getElementById("editCancelBtn").onclick = () => {
    editingMsg = null;
    editBar.style.display = "none";
    msgInput.value = "";
};

// –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º sendBtn –∫–æ–≥–¥–∞ –∏–¥—ë—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
const origSendHandler = () => {
    if (!active) return;
    const text = msgInput.value.trim();
    if (!text) return;
    const replyTo = replyingTo ? { ...replyingTo } : undefined;
    if (isGroupActive()) {
        sendGroupMsg({ type: "groupMessage", from: myName, groupId: active, text, ts: Date.now(), replyTo });
    } else {
        sendMsg({ type: "message", from: myName, to: active, text, ts: Date.now(), replyTo });
    }
    msgInput.value = "";
    myTypingActive = false;
    closeReplyBar();
};

sendBtn.onclick = () => {
    if (editingMsg) {
        const text = msgInput.value.trim();
        if (!text) return;
        const msg = editingMsg;
        const isGrpMsg = !!msg.groupId;
        const convKey = isGrpMsg ? msg.groupId : (msg.to === myName ? msg.from : msg.to);
        const found = findMsg(convKey, msg.id);
        if (found) {
            found.conv[found.idx].text = text;
            found.conv[found.idx].edited = true;
            save();
            const el = messagesEl.querySelector(`[data-id="${msg.id}"]`);
            if (el) el.replaceWith(renderMessageEl(found.conv[found.idx], isGrpMsg));
        }
        if (isGrpMsg) {
            socket.send(JSON.stringify({ type: "groupEdit", from: myName, groupId: msg.groupId, id: msg.id, text }));
        } else {
            const to = msg.to === myName ? msg.from : msg.to;
            socket.send(JSON.stringify({ type: "edit", from: myName, to, id: msg.id, text }));
        }
        editingMsg = null;
        editBar.style.display = "none";
        msgInput.value = "";
    } else {
        origSendHandler();
    }
};

// ‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∏–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∑–∞—Ç–µ–º –≤—ã–∑–≤–∞—Ç—å –∫–æ–ª–±—ç–∫(exists) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkNick(nick, cb) {
    if (!socket || socket.readyState !== WebSocket.OPEN) { cb(false); return; }
    if (!nickCallbacks[nick]) nickCallbacks[nick] = [];
    nickCallbacks[nick].push(cb);
    socket.send(JSON.stringify({ type: "checkNick", nick }));
}

// ‚îÄ‚îÄ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const friendInput = document.getElementById("friendName");
const addFriendBtn = document.getElementById("addFriend");
const friendError = document.createElement("div");
friendError.style.cssText = "font-size:12px;color:#dc2626;padding:0 12px 6px;display:none;";
friendInput.parentElement.insertAdjacentElement("afterend", friendError);

function doAddFriend() {
    const f = friendInput.value.trim();
    if (!f) return;
    if (f === myName) { friendError.textContent = "–≠—Ç–æ –≤—ã —Å–∞–º–∏"; friendError.style.display = "block"; return; }
    if (state.contacts.includes(f)) {
        friendError.textContent = "–£–∂–µ –≤ —Å–ø–∏—Å–∫–µ";
        friendError.style.display = "block";
        return;
    }
    friendError.style.display = "none";
    addFriendBtn.disabled = true;
    checkNick(f, exists => {
        addFriendBtn.disabled = false;
        if (!exists) {
            friendError.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´" + f + "¬ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç";
            friendError.style.display = "block";
            return;
        }
        friendInput.value = "";
        friendError.style.display = "none";
        state.contacts.push(f);
        save(); renderContacts();
    });
}

addFriendBtn.onclick = doAddFriend;
friendInput.addEventListener("keydown", e => { if (e.key === "Enter") doAddFriend(); });

// ‚îÄ‚îÄ –ó–≤–æ–Ω–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stopCallSound() { callSound.pause(); callSound.currentTime = 0; }
function endActiveCall() {
    if (peer) { peer.close(); peer = null; }
    if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
    stopCallSound();
    callBox.style.display = "none";
}

async function startCall() {
    if (!active) return;
    peer = createPeer(active);
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);
    socket.send(JSON.stringify({ type: "signal", from: myName, to: active, data: offer }));
    document.getElementById("callStatus").textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...";
    callBox.style.display = "flex";
}

function createPeer(callTarget) {
    const pc = new RTCPeerConnection();
    pc.onicecandidate = e => {
        if (e.candidate)
            socket.send(JSON.stringify({ type: "signal", from: myName, to: callTarget, data: e.candidate }));
    };
    pc.ontrack = e => { const a = new Audio(); a.srcObject = e.streams[0]; a.play(); };
    pc.onconnectionstatechange = () => {
        if (pc.connectionState === "connected")
            document.getElementById("callStatus").textContent = "–ó–≤–æ–Ω–æ–∫ —Å " + callTarget;
    };
    return pc;
}

async function handleSignal(data) {
    if (data.data.type === "offer") {
        pendingOffer = data;
        incomingCaller.textContent = data.from;
        incomingCall.style.display = "flex";
        callSound.play().catch(() => {});
    } else if (data.data.type === "answer") {
        if (!peer) return;
        stopCallSound();
        await peer.setRemoteDescription(new RTCSessionDescription(data.data));
        document.getElementById("callStatus").textContent = "–ó–≤–æ–Ω–æ–∫...";
    } else if (data.data === "rejected") {
        stopCallSound(); endActiveCall();
        document.getElementById("callStatus").textContent = "–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω";
    } else {
        if (peer) try { await peer.addIceCandidate(new RTCIceCandidate(data.data)); } catch {}
    }
}

document.getElementById("acceptCall").onclick = async () => {
    if (!pendingOffer) return;
    const data = pendingOffer; pendingOffer = null;
    incomingCall.style.display = "none";
    stopCallSound();
    active = data.from;
    chatHeader.firstChild.textContent = "–ß–∞—Ç —Å " + active;
    typingIndicator.textContent = "";
    appEl.classList.add("chat-open");
    renderContacts(); renderMessages();
    peer = createPeer(data.from);
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));
    await peer.setRemoteDescription(new RTCSessionDescription(data.data));
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    socket.send(JSON.stringify({ type: "signal", from: myName, to: data.from, data: answer }));
    document.getElementById("callStatus").textContent = "–ó–≤–æ–Ω–æ–∫ —Å " + data.from;
    callBox.style.display = "flex";
};

document.getElementById("rejectCall").onclick = () => {
    if (!pendingOffer) return;
    const from = pendingOffer.from; pendingOffer = null;
    incomingCall.style.display = "none";
    stopCallSound();
    socket.send(JSON.stringify({ type: "signal", from: myName, to: from, data: "rejected" }));
};

document.getElementById("callBtn").onclick = startCall;
document.getElementById("endCall").onclick = endActiveCall;

// ‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const groupModal = document.getElementById("groupModal");
const groupNameInput = document.getElementById("groupNameInput");
const groupMemberInput = document.getElementById("groupMemberInput");
const groupMembersList = document.getElementById("groupMembersList");
const groupModalError = document.getElementById("groupModalError");
let groupModalMembers = []; // –Ω–∏–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–±–µ–∑ —Å–µ–±—è)

function openGroupModal() {
    groupModalMembers = [];
    groupNameInput.value = "";
    groupMemberInput.value = "";
    groupModalError.textContent = "";
    renderGroupMembers();
    groupModal.style.display = "flex";
    groupNameInput.focus();
}

function closeGroupModal() {
    groupModal.style.display = "none";
}

function renderGroupMembers() {
    groupMembersList.innerHTML = "";
    groupModalMembers.forEach(nick => {
        const row = document.createElement("div");
        row.className = "group-member-row";
        row.textContent = nick;
        const rm = document.createElement("button");
        rm.className = "remove-member";
        rm.textContent = "‚úï";
        rm.onclick = () => {
            groupModalMembers = groupModalMembers.filter(n => n !== nick);
            renderGroupMembers();
        };
        row.appendChild(rm);
        groupMembersList.appendChild(row);
    });
}

function doAddGroupMember() {
    const nick = groupMemberInput.value.trim();
    if (!nick) return;
    if (nick === myName) { groupModalError.textContent = "–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è"; return; }
    if (groupModalMembers.includes(nick)) { groupModalError.textContent = "–£–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω"; return; }
    groupModalError.textContent = "";
    document.getElementById("groupAddMemberBtn").disabled = true;
    checkNick(nick, exists => {
        document.getElementById("groupAddMemberBtn").disabled = false;
        if (!exists) { groupModalError.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´" + nick + "¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω"; return; }
        groupModalMembers.push(nick);
        groupMemberInput.value = "";
        groupModalError.textContent = "";
        renderGroupMembers();
    });
}

document.getElementById("newGroupBtn").onclick = openGroupModal;
document.getElementById("groupCancelBtn").onclick = closeGroupModal;
groupModal.addEventListener("click", e => { if (e.target === groupModal) closeGroupModal(); });
document.getElementById("groupAddMemberBtn").onclick = doAddGroupMember;
groupMemberInput.addEventListener("keydown", e => { if (e.key === "Enter") doAddGroupMember(); });

document.getElementById("groupCreateBtn").onclick = () => {
    const name = groupNameInput.value.trim();
    if (!name) { groupModalError.textContent = "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"; return; }
    if (name.length > 64) { groupModalError.textContent = "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ"; return; }
    if (groupModalMembers.length < 1) { groupModalError.textContent = "–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞"; return; }
    socket.send(JSON.stringify({ type: "createGroup", name, members: groupModalMembers }));
    closeGroupModal();
};

// ‚îÄ‚îÄ –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const forwardModal = document.getElementById("forwardModal");
const forwardSearch = document.getElementById("forwardSearch");
const forwardListEl = document.getElementById("forwardList");
let forwardingMsg = null;

function openForwardModal(msg) {
    forwardingMsg = msg;
    forwardSearch.value = "";
    renderForwardList("");
    forwardModal.style.display = "flex";
    forwardSearch.focus();
}
function closeForwardModal() { forwardModal.style.display = "none"; forwardingMsg = null; }

function renderForwardList(query) {
    forwardListEl.innerHTML = "";
    const q = query.toLowerCase();
    // –õ–∏—á–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
    state.contacts.forEach(name => {
        if (q && !name.toLowerCase().includes(q)) return;
        const d = document.createElement("div");
        d.className = "forward-item";
        d.innerHTML = '<span style="color:var(--text2);font-size:15px">üë§</span> ' + name;
        d.onclick = () => doForward(name, false);
        forwardListEl.appendChild(d);
    });
    // –ì—Ä—É–ø–ø—ã
    Object.values(state.groups).forEach(g => {
        if (q && !g.name.toLowerCase().includes(q)) return;
        const d = document.createElement("div");
        d.className = "forward-item";
        d.innerHTML = '<span style="color:var(--text2);font-size:15px">üë•</span> ' + g.name;
        d.onclick = () => doForward(g.id, true);
        forwardListEl.appendChild(d);
    });
}

function doForward(target, isGroup) {
    if (!forwardingMsg) return;
    const m = forwardingMsg;
    const fwdFrom = m.forwardedFrom || m.from; // —Ü–µ–ø–æ—á–∫–∞: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    const base = {
        forwardedFrom: fwdFrom,
        text: m.text || "",
        ts: Date.now(),
    };
    // –ö–æ–ø–∏—Ä—É–µ–º –º–µ–¥–∏–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (m.mediaType) { base.mediaType = m.mediaType; base.mediaData = m.mediaData; base.fileName = m.fileName; }

    if (isGroup) {
        sendGroupMsg(Object.assign({ type: "groupMessage", from: myName, groupId: target }, base));
    } else {
        sendMsg(Object.assign({ type: "message", from: myName, to: target }, base));
    }
    closeForwardModal();
    // –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –∫—É–¥–∞ –ø–µ—Ä–µ—Å–ª–∞–ª–∏
    if (isGroup) openGroupChat(target); else openChat(target);
}

document.getElementById("forwardCancelBtn").onclick = closeForwardModal;
forwardModal.addEventListener("click", e => { if (e.target === forwardModal) closeForwardModal(); });
forwardSearch.addEventListener("input", () => renderForwardList(forwardSearch.value));

// –ö–Ω–æ–ø–∫–∞ ¬´–ü–µ—Ä–µ—Å–ª–∞—Ç—å¬ª –≤ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è
document.getElementById("msgCtxForward").onclick = () => {
    if (!msgCtxTarget) return;
    const msg = msgCtxTarget;
    hideMsgCtxMenu();
    openForwardModal(msg);
};

// ‚îÄ‚îÄ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –≥—Ä—É–ø–ø—É ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const addMemberModal = document.getElementById("addMemberModal");
const addMemberNickInput = document.getElementById("addMemberNickInput");
const addMemberError = document.getElementById("addMemberError");

function openAddMemberModal() {
    addMemberNickInput.value = "";
    addMemberError.textContent = "";
    document.getElementById("addMemberConfirmBtn").disabled = false;
    addMemberModal.style.display = "flex";
    addMemberNickInput.focus();
}
function closeAddMemberModal() { addMemberModal.style.display = "none"; }

document.getElementById("addMemberBtn").onclick = openAddMemberModal;
document.getElementById("addMemberCancelBtn").onclick = closeAddMemberModal;
addMemberModal.addEventListener("click", e => { if (e.target === addMemberModal) closeAddMemberModal(); });

function doAddMember() {
    const nick = addMemberNickInput.value.trim();
    if (!nick) return;
    addMemberError.textContent = "";
    document.getElementById("addMemberConfirmBtn").disabled = true;
    socket.send(JSON.stringify({ type: "addGroupMember", groupId: active, nick }));
    // –û—Ç–≤–µ—Ç –ø—Ä–∏–¥—ë—Ç —á–µ—Ä–µ–∑ groupMemberAdded –∏–ª–∏ addMemberError
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ handler)
}

document.getElementById("addMemberConfirmBtn").onclick = doAddMember;
addMemberNickInput.addEventListener("keydown", e => { if (e.key === "Enter") doAddMember(); });

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ ‚Äî –ø–∞—Ç—á–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
const _origGroupMemberAdded = (gid) => {
    if (addMemberModal.style.display === "flex" && active === gid) closeAddMemberModal();
};

// ‚îÄ‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Notification API + Web Push) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let swRegistration = null;

// –ü–æ–∫–∞–∑–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–∫–æ–≥–¥–∞ –≤–∫–ª–∞–¥–∫–∞ –Ω–µ –≤ —Ñ–æ–∫—É—Å–µ)
function showNotification(title, body, tag) {
    if (document.visibilityState === 'visible') return; // –≤–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
    if (!('Notification' in window)) return;
    if (Notification.permission !== 'granted') return;
    const opts = { body, tag, icon: '/icon-192.png', badge: '/icon-192.png', renotify: true, vibrate: [200, 100, 200] };
    if (swRegistration) {
        swRegistration.showNotification(title, opts);
    } else {
        new Notification(title, opts);
    }
}

// –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏ –ø–æ–¥–ø–∏—Å–∞—Ç—å –Ω–∞ Web Push
async function setupNotifications() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') {
        await Notification.requestPermission();
    }
    if (Notification.permission !== 'granted') return;
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;

    try {
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º SW
        swRegistration = await navigator.serviceWorker.register('/sw.js');
        await navigator.serviceWorker.ready;

        // –ü–æ–ª—É—á–∞–µ–º VAPID public key —Å —Å–µ—Ä–≤–µ—Ä–∞
        const vapidResp = await fetch('/vapid-public-key');
        const vapidKey  = await vapidResp.text();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É
        let sub = await swRegistration.pushManager.getSubscription();
        if (!sub) {
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è
            const appKey = Uint8Array.from(atob(vapidKey.replace(/-/g,'+').replace(/_/g,'/')), c => c.charCodeAt(0));
            sub = await swRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: appKey
            });
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        await fetch('/push-subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nick: myName, subscription: sub.toJSON() })
        });
    } catch (e) {
        console.warn('Push setup failed:', e);
    }
}

// –í—ã–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
// (–ø–∞—Ç—á–∏–º socket.onmessage —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å setupNotifications –ø–æ—Å–ª–µ authResult)
const _origConnectAndAuth = connectAndAuth;

// ‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderContacts();
</script>
</body>
</html>
