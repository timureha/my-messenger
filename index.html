<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messenger PRO</title>

<style>
:root{--accent:#2563eb;--bg:#f3f4f6}
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:var(--bg);height:100vh;display:flex}
.app{display:grid;grid-template-columns:280px 1fr;width:100%;padding:10px;gap:10px}
.panel{background:#fff;border-radius:10px;box-shadow:0 8px 25px rgba(0,0,0,.08);display:flex;flex-direction:column}
.top{padding:12px;border-bottom:1px solid #eee;font-weight:bold}
.contacts{flex:1;overflow:auto}
.contact{padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.contact .name{display:flex;align-items:center;gap:6px}
.unread{font-weight:bold}
.badge{background:#ef4444;color:white;border-radius:12px;padding:2px 8px;font-size:12px}
.online{color:green;font-size:12px}
.offline{color:red;font-size:12px}
.messages{flex:1;padding:15px;overflow:auto}
.message{margin-bottom:10px;max-width:70%;padding:8px;border-radius:8px}
.me{background:#dbeafe;margin-left:auto}
.them{background:#f1f5f9}
.composer{display:flex;padding:10px;border-top:1px solid #eee;gap:6px}
input{padding:8px;border-radius:6px;border:1px solid #ddd}
button{padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
.primary{background:var(--accent);color:#fff}
.callBox{position:fixed;bottom:20px;right:20px;background:#fff;padding:15px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none}
</style>
</head>

<body>
<div class="app">

<div class="panel">
<div class="top">
<input id="myName" placeholder="–í–∞—à –Ω–∏–∫">
<input id="myPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button id="connectBtn">–í–æ–π—Ç–∏</button>
</div>

<div style="padding:10px;border-bottom:1px solid #eee;display:flex;gap:5px">
<input id="friendName" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞" style="flex:1">
<button id="addFriend">+</button>
</div>

<div class="contacts" id="contacts"></div>
</div>

<div class="panel">
<div class="top" id="chatHeader">–ß–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
<div class="messages" id="messages"></div>

<div class="composer">
<input id="messageInput" style="flex:1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
<button class="primary" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
<button id="callBtn">üìû</button>
</div>
</div>

</div>

<div class="callBox" id="callBox">
<div id="callStatus">–ó–≤–æ–Ω–æ–∫...</div>
<button id="endCall">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
</div>

<audio id="msgSound" src="message.mp3" preload="auto"></audio>

<script>
let socket;
let myName = "";
let state = JSON.parse(localStorage.getItem("messenger_state") || '{"contacts":[],"conversations":{},"online":{},"lastActivity":{},"unread":{}}');
let active = null;

let peer;
let localStream;

const contactsEl = document.getElementById("contacts");
const messagesEl = document.getElementById("messages");
const chatHeader = document.getElementById("chatHeader");
const msgSound = document.getElementById("msgSound");
const callBox = document.getElementById("callBox");

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–æ–ª–µ–π (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π)
if (!state.lastActivity) state.lastActivity = {};
if (!state.unread) state.unread = {};

function save() {
    localStorage.setItem("messenger_state", JSON.stringify(state));
}

function renderContacts() {
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã: —Å–Ω–∞—á–∞–ª–∞ —Ç–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å lastActivity (–ø–æ —É–±—ã–≤–∞–Ω–∏—é), –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
    const sorted = [...state.contacts].sort((a, b) => {
        const tA = state.lastActivity[a] || 0;
        const tB = state.lastActivity[b] || 0;
        if (tA !== tB) return tB - tA;
        return a.localeCompare(b);
    });

    contactsEl.innerHTML = "";
    sorted.forEach(name => {
        const unreadCount = state.unread[name] || 0;
        const div = document.createElement("div");
        div.className = "contact";
        div.innerHTML = `
            <span class="name ${unreadCount > 0 ? 'unread' : ''}">
                ${name}
                ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : ''}
            </span>
            <span class="${state.online[name] ? 'online' : 'offline'}">
                ${state.online[name] ? '‚óè online' : '‚óè offline'}
            </span>
        `;
        div.onclick = () => {
            active = name;
            chatHeader.textContent = "–ß–∞—Ç —Å " + name;
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
            if (state.unread[name]) {
                state.unread[name] = 0;
                save();
            }
            renderMessages();
            renderContacts(); // —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –∂–∏—Ä–Ω–æ—Å—Ç—å/–±–µ–π–¥–∂
        };
        contactsEl.appendChild(div);
    });
}

function renderMessages() {
    messagesEl.innerHTML = "";
    if (!active) return;

    const conv = state.conversations[active] || [];
    conv.forEach(m => {
        const div = document.createElement("div");
        div.className = "message " + (m.from === myName ? "me" : "them");
        div.textContent = m.text;
        messagesEl.appendChild(div);
    });
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

function connect() {
    myName = document.getElementById("myName").value.trim();
    const password = document.getElementById("myPassword").value.trim();
    if (!myName || !password) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å");

    socket = new WebSocket("ws://localhost:3000");

    socket.onopen = () => {
        socket.send(JSON.stringify({ type: "auth", name: myName, password }));
    };

    socket.onmessage = async e => {
        let data = JSON.parse(e.data);

        if (data.type === "error") {
            alert("–û—à–∏–±–∫–∞: " + data.message);
            socket.close();
            return;
        }

        if (data.type === "onlineList") {
            state.online = data.users;
            save();
            renderContacts();
        }

        if (data.type === "message") {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (!state.conversations[data.from])
                state.conversations[data.from] = [];
            state.conversations[data.from].push(data);
            if (!state.contacts.includes(data.from))
                state.contacts.push(data.from);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            state.lastActivity[data.from] = Date.now();

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
            if (active !== data.from) {
                state.unread[data.from] = (state.unread[data.from] || 0) + 1;
            }

            msgSound.play();
            save();
            renderContacts();
            renderMessages();
        }

        if (data.type === "signal") {
            await handleSignal(data);
        }
    };

    socket.onclose = () => {
        // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    };
}

async function startCall() {
    if (!active) return;
    peer = createPeer();
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);

    socket.send(JSON.stringify({
        type: "signal",
        from: myName,
        to: active,
        data: offer
    }));
}

function createPeer() {
    const pc = new RTCPeerConnection();

    pc.onicecandidate = e => {
        if (e.candidate) {
            socket.send(JSON.stringify({
                type: "signal",
                from: myName,
                to: active,
                data: e.candidate
            }));
        }
    };

    pc.ontrack = e => {
        const audio = new Audio();
        audio.srcObject = e.streams[0];
        audio.play();
    };

    return pc;
}

async function handleSignal(data) {
    if (!peer) peer = createPeer();

    if (data.data.type === "offer") {
        active = data.from;
        chatHeader.textContent = "–ß–∞—Ç —Å " + active;

        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

        await peer.setRemoteDescription(new RTCSessionDescription(data.data));
        const answer = await peer.createAnswer();
        await peer.setLocalDescription(answer);

        socket.send(JSON.stringify({
            type: "signal",
            from: myName,
            to: data.from,
            data: answer
        }));

        callBox.style.display = "block";
    } else if (data.data.type === "answer") {
        await peer.setRemoteDescription(new RTCSessionDescription(data.data));
        callBox.style.display = "block";
    } else {
        try {
            await peer.addIceCandidate(new RTCIceCandidate(data.data));
        } catch { }
    }
}

document.getElementById("connectBtn").onclick = connect;
document.getElementById("addFriend").onclick = () => {
    let f = document.getElementById("friendName").value.trim();
    if (!f) return;
    if (!state.contacts.includes(f))
        state.contacts.push(f);
    document.getElementById("friendName").value = "";
    save();
    renderContacts();
};
document.getElementById("sendBtn").onclick = () => {
    if (!active) return;
    let text = document.getElementById("messageInput").value;
    if (!text) return;
    let msg = { type: "message", from: myName, to: active, text };
    if (!state.conversations[active])
        state.conversations[active] = [];
    state.conversations[active].push(msg);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è = —á–∞—Ç –ø—Ä–æ—á–∏—Ç–∞–Ω)
    state.lastActivity[active] = Date.now();
    if (state.unread[active]) state.unread[active] = 0;
    
    socket.send(JSON.stringify(msg));
    document.getElementById("messageInput").value = "";
    save();
    renderMessages();
    renderContacts(); // –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏ –±–µ–π–¥–∂–∏
};
document.getElementById("callBtn").onclick = startCall;
document.getElementById("endCall").onclick = () => {
    if (peer) peer.close();
    callBox.style.display = "none";
};

renderContacts();
</script>

</body>
</html>
